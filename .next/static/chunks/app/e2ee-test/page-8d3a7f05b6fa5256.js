(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[173],{6228:(e,t,r)=>{Promise.resolve().then(r.bind(r,7011))},6812:(e,t,r)=>{"use strict";r.d(t,{QD:()=>o,e2eeStorage:()=>i,gU:()=>a});class s{async init(){return new Promise((e,t)=>{let r=indexedDB.open(this.DB_NAME,this.DB_VERSION);r.onerror=()=>t(r.error),r.onsuccess=()=>{this.db=r.result,e()},r.onupgradeneeded=e=>{let t=e.target.result;if(t.objectStoreNames.contains("identity")||t.createObjectStore("identity",{keyPath:"id"}).createIndex("fingerprint","fingerprint",{unique:!0}),!t.objectStoreNames.contains("prekeys")){let e=t.createObjectStore("prekeys",{keyPath:"id"});e.createIndex("used","used",{unique:!1}),e.createIndex("createdAt","createdAt",{unique:!1})}t.objectStoreNames.contains("sessions")||t.createObjectStore("sessions",{keyPath:"peerUserId"}).createIndex("lastUsedAt","lastUsedAt",{unique:!1}),t.objectStoreNames.contains("trustedPeers")||t.createObjectStore("trustedPeers",{keyPath:"userId"}).createIndex("fingerprint","fingerprint",{unique:!0})}})}async ensureDB(){return this.db||await this.init(),this.db}async saveIdentityKey(e){let t=await this.ensureDB();return new Promise((r,s)=>{let i=t.transaction(["identity"],"readwrite").objectStore("identity").put({id:"current",...e});i.onerror=()=>s(i.error),i.onsuccess=()=>r()})}async getIdentityKey(){let e=await this.ensureDB();return new Promise((t,r)=>{let s=e.transaction(["identity"],"readonly").objectStore("identity").get("current");s.onerror=()=>r(s.error),s.onsuccess=()=>t(s.result||null)})}async savePreKey(e){let t=await this.ensureDB();return new Promise((r,s)=>{let i=t.transaction(["prekeys"],"readwrite").objectStore("prekeys").put(e);i.onerror=()=>s(i.error),i.onsuccess=()=>r()})}async getUnusedPreKey(){let e=await this.ensureDB();return new Promise((t,r)=>{let s=e.transaction(["prekeys"],"readonly").objectStore("prekeys").index("used").getAll();s.onerror=()=>r(s.error),s.onsuccess=()=>{t((s.result||[]).find(e=>!e.used)||null)}})}async markPreKeyAsUsed(e){let t=await this.ensureDB();return new Promise((r,s)=>{let i=t.transaction(["prekeys"],"readwrite").objectStore("prekeys"),a=i.get(e);a.onerror=()=>s(a.error),a.onsuccess=()=>{let e=a.result;if(e){e.used=!0;let t=i.put(e);t.onerror=()=>s(t.error),t.onsuccess=()=>r()}else s(Error("PreKey not found"))}})}async getPreKeys(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:100,t=await this.ensureDB();return new Promise((r,s)=>{let i=t.transaction(["prekeys"],"readonly").objectStore("prekeys").index("used").getAll();i.onerror=()=>s(i.error),i.onsuccess=()=>{r((i.result||[]).filter(e=>!e.used).slice(0,e))}})}async saveSession(e){let t=await this.ensureDB();return new Promise((r,s)=>{let i=t.transaction(["sessions"],"readwrite").objectStore("sessions").put(e);i.onerror=()=>s(i.error),i.onsuccess=()=>r()})}async getSession(e){let t=await this.ensureDB();return new Promise((r,s)=>{let i=t.transaction(["sessions"],"readonly").objectStore("sessions").get(e);i.onerror=()=>s(i.error),i.onsuccess=()=>r(i.result||null)})}async updateSession(e,t){let r=await this.ensureDB();return new Promise((s,i)=>{let a=r.transaction(["sessions"],"readwrite").objectStore("sessions"),n=a.get(e);n.onerror=()=>i(n.error),n.onsuccess=()=>{let e=n.result;if(e){let r={...e,...t,lastUsedAt:new Date},n=a.put(r);n.onerror=()=>i(n.error),n.onsuccess=()=>s()}else i(Error("Session not found"))}})}async updateSessionWithRootKey(e,t,r,s){let i=await this.ensureDB();return new Promise((a,n)=>{let o=i.transaction(["sessions"],"readwrite").objectStore("sessions"),c=o.get(e);c.onerror=()=>n(c.error),c.onsuccess=()=>{let e=c.result;if(e){let i={lastUsedAt:new Date};void 0!==t&&(i.sendCounter=t),void 0!==r&&(i.recvCounter=r),void 0!==s&&(i.rootKey=s);let c={...e,...i},l=o.put(c);l.onerror=()=>n(l.error),l.onsuccess=()=>a()}else n(Error("Session not found"))}})}async getAllSessions(){let e=await this.ensureDB();return new Promise((t,r)=>{let s=e.transaction(["sessions"],"readonly").objectStore("sessions").getAll();s.onerror=()=>r(s.error),s.onsuccess=()=>t(s.result||[])})}async saveTrustedPeer(e){let t=await this.ensureDB();return new Promise((r,s)=>{let i=t.transaction(["trustedPeers"],"readwrite").objectStore("trustedPeers").put(e);i.onerror=()=>s(i.error),i.onsuccess=()=>r()})}async getTrustedPeer(e){let t=await this.ensureDB();return new Promise((r,s)=>{let i=t.transaction(["trustedPeers"],"readonly").objectStore("trustedPeers").get(e);i.onerror=()=>s(i.error),i.onsuccess=()=>r(i.result||null)})}async updateTrustedPeerVerification(e){let t=await this.ensureDB();return new Promise((r,s)=>{let i=t.transaction(["trustedPeers"],"readwrite").objectStore("trustedPeers"),a=i.get(e);a.onerror=()=>s(a.error),a.onsuccess=()=>{let e=a.result;if(e){e.lastVerifiedAt=new Date;let t=i.put(e);t.onerror=()=>s(t.error),t.onsuccess=()=>r()}else s(Error("TrustedPeer not found"))}})}async cleanupExpiredPreKeys(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:6048e5,t=await this.ensureDB();return new Promise((r,s)=>{let i=t.transaction(["prekeys"],"readwrite").objectStore("prekeys").index("createdAt"),a=new Date(Date.now()-e),n=i.openCursor(IDBKeyRange.upperBound(a));n.onerror=()=>s(n.error),n.onsuccess=()=>{let e=n.result;e?(e.delete(),e.continue()):r()}})}async clearAll(){let e=await this.ensureDB();return new Promise((t,r)=>{let s=e.transaction(["identity","prekeys","sessions","trustedPeers"],"readwrite"),i=["identity","prekeys","sessions","trustedPeers"],a=0;i.forEach(e=>{let n=s.objectStore(e).clear();n.onerror=()=>r(n.error),n.onsuccess=()=>{++a===i.length&&t()}})})}constructor(){this.db=null,this.DB_NAME="E2EEChatDB",this.DB_VERSION=1}}let i=new s;function a(){return"undefined"!=typeof indexedDB}class n{async saveIdentityKey(e){localStorage.setItem(this.PREFIX+"identity",JSON.stringify(e))}async getIdentityKey(){let e=localStorage.getItem(this.PREFIX+"identity");return e?JSON.parse(e):null}async saveSession(e){localStorage.setItem(this.PREFIX+"session_".concat(e.peerUserId),JSON.stringify(e))}async getSession(e){let t=localStorage.getItem(this.PREFIX+"session_".concat(e));if(!t)return null;let r=JSON.parse(t);return r.establishedAt=new Date(r.establishedAt),r.lastUsedAt=new Date(r.lastUsedAt),r}async saveTrustedPeer(e){localStorage.setItem(this.PREFIX+"trusted_".concat(e.userId),JSON.stringify(e))}async getTrustedPeer(e){let t=localStorage.getItem(this.PREFIX+"trusted_".concat(e));if(!t)return null;let r=JSON.parse(t);return r.trustedAt=new Date(r.trustedAt),r.lastVerifiedAt&&(r.lastVerifiedAt=new Date(r.lastVerifiedAt)),r}async savePreKey(e){localStorage.setItem(this.PREFIX+"prekey_".concat(e.id),JSON.stringify(e))}async getUnusedPreKey(){for(let e of Object.keys(localStorage))if(e.startsWith(this.PREFIX+"prekey_")){let t=localStorage.getItem(e);if(!t)continue;let r=JSON.parse(t);if(!r.used)return r}return null}async markPreKeyAsUsed(e){let t=this.PREFIX+"prekey_".concat(e),r=localStorage.getItem(t);if(!r)throw Error("PreKey not found");let s=JSON.parse(r);s.used=!0,localStorage.setItem(t,JSON.stringify(s))}async getPreKeys(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:100,t=Object.keys(localStorage),r=[];for(let s of t)if(s.startsWith(this.PREFIX+"prekey_")){let t=localStorage.getItem(s);if(!t)continue;let i=JSON.parse(t);if(r.push(i),r.length>=e)break}return r.sort((e,t)=>new Date(e.createdAt).getTime()-new Date(t.createdAt).getTime()),r}async updateSession(e,t){let r=await this.getSession(e);if(!r)throw Error("Session not found");let s={...r,...t,lastUsedAt:new Date};localStorage.setItem(this.PREFIX+"session_".concat(e),JSON.stringify(s))}async updateSessionWithRootKey(e,t,r,s){let i=await this.getSession(e);if(!i)throw Error("Session not found");let a={lastUsedAt:new Date};void 0!==t&&(a.sendCounter=t),void 0!==r&&(a.recvCounter=r),void 0!==s&&(a.rootKey=s);let n={...i,...a};localStorage.setItem(this.PREFIX+"session_".concat(e),JSON.stringify(n))}async getAllSessions(){let e=Object.keys(localStorage),t=[];for(let r of e)if(r.startsWith(this.PREFIX+"session_")){let e=localStorage.getItem(r);if(!e)continue;let s=JSON.parse(e);s.establishedAt=new Date(s.establishedAt),s.lastUsedAt=new Date(s.lastUsedAt),t.push(s)}return t}async updateTrustedPeerVerification(e){let t=await this.getTrustedPeer(e);if(!t)throw Error("TrustedPeer not found");t.lastVerifiedAt=new Date,await this.saveTrustedPeer(t)}constructor(){this.PREFIX="e2ee_"}}let o=new n},7011:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>v});var s=r(5155),i=r(2115),a=r(9942),n=r(6812);class o{async initializeIdentity(){let e=await this.storage.getIdentityKey();if(e)return e;let t=await (0,a.dZ)(),r=await (0,a.ds)(t.publicKey),s={privateKey:await (0,a.xu)(t.privateKey),publicKey:r,fingerprint:await (0,a.zJ)(t.publicKey),createdAt:new Date};return await this.storage.saveIdentityKey(s),s}async generatePreKeys(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:100,t=[];for(let r=0;r<e;r++){let e=await (0,a.c2)(),s=await (0,a.ds)(e.publicKey),i=await (0,a.xu)(e.privateKey),n={id:"prekey_".concat(Date.now(),"_").concat(r),privateKey:i,publicKey:s,createdAt:new Date,used:!1};await this.storage.savePreKey(n),t.push(n)}return t}async establishSession(e){let t,r=await this.storage.getIdentityKey();if(!r)throw Error("Identity key not initialized");let s=await (0,a.GR)(r.privateKey),i=await (0,a.KG)(e.identityKey),n=await (0,a.KG)(e.signedPreKey),o=(await (0,a.dZ)()).privateKey,c=[],l=await (0,a.Hi)(s,n);c.push(l);let d=await (0,a.Hi)(o,i);if(c.push(d),e.oneTimePreKey){let r=await (0,a.KG)(e.oneTimePreKey.publicKey),s=await (0,a.Hi)(o,r);c.push(s),t=e.oneTimePreKey.id}let u=(0,a.NA)(...c),y=(0,a.Gg)(32),g=new ArrayBuffer(y.byteLength);new Uint8Array(g).set(y);let h=await (0,a.sM)(u,g,"E2EE-Root-Key",32),p={peerUserId:e.userId,rootKey:(0,a.Yi)(h),sendCounter:0,recvCounter:0,peerIdentityKey:e.identityKey,peerSignedPreKey:e.signedPreKey,usedPreKeyId:t,establishedAt:new Date,lastUsedAt:new Date};await this.storage.saveSession(p);let f=!await this.storage.getTrustedPeer(e.userId);if(f){let t={userId:e.userId,fingerprint:await (0,a.zJ)(i),trustedAt:new Date};await this.storage.saveTrustedPeer(t)}return{session:p,fingerprint:await (0,a.zJ)(i),isNewTrust:f}}async getOrEstablishSession(e){let t=await this.storage.getSession(e.userId);return t||(await this.establishSession(e)).session}async verifyPeerFingerprint(e,t){let r=await this.storage.getTrustedPeer(e);if(!r)return!1;let s=r.fingerprint===t;return s&&await this.storage.updateTrustedPeerVerification(e),s}async updateSessionCounters(e,t,r){if((0,n.gU)())await n.e2eeStorage.updateSessionWithRootKey(e,t,r);else{let s={};void 0!==t&&(s.sendCounter=t),void 0!==r&&(s.recvCounter=r),await this.storage.updateSession(e,s)}}async getSession(e){return await this.storage.getSession(e)}async deleteSession(e){await this.storage.updateSession(e,{rootKey:"",sendCounter:-1,recvCounter:-1})}async getAllSessions(){return await this.storage.getAllSessions()}async cleanupExpiredSessions(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:2592e6,t=await this.storage.getAllSessions(),r=Date.now()-e;for(let e of t)e.lastUsedAt.getTime()<r&&await this.deleteSession(e.peerUserId)}async getIdentityKeyInfo(){let e=await this.storage.getIdentityKey();return e?{publicKey:e.publicKey,fingerprint:e.fingerprint}:null}async getPreKeysForUpload(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:100;return(await this.storage.getPreKeys(e)).filter(e=>!e.used).map(e=>({id:e.id,publicKey:e.publicKey}))}async markPreKeyAsUsed(e){await this.storage.markPreKeyAsUsed(e)}async reset(){(0,n.gU)()?await n.e2eeStorage.clearAll():Object.keys(localStorage).forEach(e=>{e.startsWith("e2ee_")&&localStorage.removeItem(e)})}constructor(){this.storage=(0,n.gU)()?n.e2eeStorage:n.QD}}let c=new o;class l{async encryptText(e,t){let r=await c.getSession(e);if(!r)throw Error("No session found for peer: ".concat(e));let s=r.sendCounter+1,i=await (0,a.oH)((0,a.Ms)(r.rootKey),s,"encrypt"),n=(0,a.Gg)(12),o=new TextEncoder().encode(t),l=await (0,a.G5)(i,o,n);return await c.updateSessionCounters(e,s),{ciphertext:(0,a.Yi)(l.buffer.slice(l.byteOffset,l.byteOffset+l.byteLength)),iv:(0,a.Yi)(n.buffer.slice(n.byteOffset,n.byteOffset+n.byteLength)),counter:s,algorithm:"AES-GCM-256"}}async decryptText(e,t){try{let r=await c.getSession(e);if(!r)return{plaintext:"",isValid:!1,error:"No session found"};if(t.counter<=r.recvCounter)return{plaintext:"",isValid:!1,error:"Message counter too low (possible replay attack)"};let s=await (0,a.oH)((0,a.Ms)(r.rootKey),t.counter,"decrypt"),i=(0,a.Ms)(t.ciphertext),n=(0,a.Ms)(t.iv),o=await (0,a.sQ)(s,new Uint8Array(i),new Uint8Array(n));return await c.updateSessionCounters(e,void 0,t.counter),{plaintext:new TextDecoder().decode(o),isValid:!0}}catch(e){return{plaintext:"",isValid:!1,error:e instanceof Error?e.message:"Decryption failed"}}}async encryptMedia(e,t){let r=await c.getSession(e);if(!r)throw Error("No session found for peer: ".concat(e));let s=r.sendCounter+1,i=await (0,a.lI)((0,a.Ms)(r.rootKey),s),n=(0,a.Gg)(12),o=new Uint8Array(await t.arrayBuffer()),l=await (0,a.G5)(i,o,n);await c.updateSessionCounters(e,s);let d=new Uint8Array(l.length);return d.set(l),{ciphertext:new Blob([d],{type:"application/octet-stream"}),iv:(0,a.Yi)(n.buffer.slice(n.byteOffset,n.byteOffset+n.byteLength)),counter:s,algorithm:"AES-GCM-256",metadata:{size:t.size,type:t.type,name:t.name}}}async decryptMedia(e,t){try{let r=await c.getSession(e);if(!r)return{plaintext:new ArrayBuffer(0),isValid:!1,error:"No session found"};if(t.counter<=r.recvCounter)return{plaintext:new ArrayBuffer(0),isValid:!1,error:"Media counter too low (possible replay attack)"};let s=await (0,a.lI)((0,a.Ms)(r.rootKey),t.counter),i=await t.ciphertext.arrayBuffer(),n=new Uint8Array(i),o=(0,a.Ms)(t.iv),l=await (0,a.sQ)(s,n,new Uint8Array(o));await c.updateSessionCounters(e,void 0,t.counter);let d=new ArrayBuffer(l.byteLength);return new Uint8Array(d).set(l),{plaintext:d,isValid:!0}}catch(e){return{plaintext:new ArrayBuffer(0),isValid:!1,error:e instanceof Error?e.message:"Media decryption failed"}}}async encryptMessages(e,t){let r=await c.getSession(e);if(!r)throw Error("No session found for peer: ".concat(e));let s=[],i=r.sendCounter;for(let e of t){i++;let t=await (0,a.oH)((0,a.Ms)(r.rootKey),i,"encrypt"),n=(0,a.Gg)(12),o=new TextEncoder().encode(e),c=await (0,a.G5)(t,o,n);s.push({ciphertext:(0,a.Yi)(c.buffer.slice(c.byteOffset,c.byteOffset+c.byteLength)),iv:(0,a.Yi)(n.buffer.slice(n.byteOffset,n.byteOffset+n.byteLength)),counter:i,algorithm:"AES-GCM-256"})}return await c.updateSessionCounters(e,i),s}async verifyMessageIntegrity(e,t){try{let r=await c.getSession(e);if(!r||t.counter<=r.recvCounter||"AES-GCM-256"!==t.algorithm)return!1;try{(0,a.Ms)(t.ciphertext),(0,a.Ms)(t.iv)}catch(e){return!1}return!0}catch(e){return!1}}async getSessionInfo(e){let t=await c.getSession(e);return t?{isEstablished:t.rootKey.length>0&&t.sendCounter>=0,sendCounter:t.sendCounter,recvCounter:t.recvCounter,establishedAt:t.establishedAt,lastUsedAt:t.lastUsedAt}:null}async rotateSessionKey(e){try{if(!await c.getSession(e))return!1;let t=(0,a.Gg)(32);await c.updateSessionCounters(e,0,0);let{e2eeStorage:s}=await Promise.resolve().then(r.bind(r,6812));return await s.updateSessionWithRootKey(e,0,0,(0,a.Yi)(t.buffer.slice(t.byteOffset,t.byteOffset+t.byteLength))),!0}catch(e){return!1}}}let d=new l;class u{async initialize(){if(!this.isInitialized)try{await c.initializeIdentity(),await c.generatePreKeys(50),await this.uploadKeysToServer(),this.isInitialized=!0,this.log("E2EE service initialized successfully")}catch(e){throw this.log("Failed to initialize E2EE service:",e),e}}async uploadKeysToServer(){try{let e=await c.getIdentityKeyInfo(),t=await c.getPreKeysForUpload(50);if(!e)throw Error("Identity key not found");let r=(await c.generatePreKeys(1))[0],s={userId:this.config.currentUserId,identityKey:e.publicKey,signedPreKey:r.publicKey,signedPreKeyId:r.id,oneTimePreKeys:t},i=await fetch("".concat(this.config.apiBaseUrl,"/keys"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(!i.ok)throw Error("Failed to upload keys: ".concat(i.statusText));this.log("Keys uploaded to server successfully")}catch(e){throw this.log("Failed to upload keys to server:",e),e}}async establishSession(e){try{let t=await this.fetchPeerKeys(e),r=await c.establishSession(t);return this.log("Session established with ".concat(e,", fingerprint: ").concat(r.fingerprint)),r}catch(t){throw this.log("Failed to establish session with ".concat(e,":"),t),t}}async fetchPeerKeys(e){let t=await fetch("".concat(this.config.apiBaseUrl,"/keys/").concat(e));if(!t.ok)throw Error("Failed to fetch peer keys: ".concat(t.statusText));let r=await t.json();return{userId:r.userId,identityKey:r.identityKey,signedPreKey:r.signedPreKey,signedPreKeyId:r.signedPreKeyId,oneTimePreKey:r.oneTimePreKey}}async encryptAndSendText(e,t){try{await this.ensureSession(e);let r=await d.encryptText(e,t);return this.log("Text message encrypted for ".concat(e)),r}catch(t){throw this.log("Failed to encrypt text message for ".concat(e,":"),t),t}}async encryptAndSendMedia(e,t){try{await this.ensureSession(e);let r=await d.encryptMedia(e,t);return this.log("Media file encrypted for ".concat(e,": ").concat(t.name)),r}catch(t){throw this.log("Failed to encrypt media file for ".concat(e,":"),t),t}}async decryptTextMessage(e,t){try{let r=await d.decryptText(e,t);return r.isValid?this.log("Text message decrypted from ".concat(e)):this.log("Failed to decrypt text message from ".concat(e,": ").concat(r.error)),r}catch(t){return this.log("Error decrypting text message from ".concat(e,":"),t),{plaintext:"",isValid:!1,error:t instanceof Error?t.message:"Decryption error"}}}async decryptMediaMessage(e,t){try{let r=await d.decryptMedia(e,t);return r.isValid?this.log("Media file decrypted from ".concat(e,": ").concat(t.metadata.name)):this.log("Failed to decrypt media file from ".concat(e,": ").concat(r.error)),r}catch(t){return this.log("Error decrypting media file from ".concat(e,":"),t),{plaintext:new ArrayBuffer(0),isValid:!1,error:t instanceof Error?t.message:"Media decryption error"}}}async ensureSession(e){let t=await c.getSession(e);t&&0!==t.rootKey.length||await this.establishSession(e)}async getSessionInfo(e){return await d.getSessionInfo(e)}async verifyPeerFingerprint(e,t){return await c.verifyPeerFingerprint(e,t)}async rotateSessionKey(e){return await d.rotateSessionKey(e)}async getMyFingerprint(){let e=await c.getIdentityKeyInfo();return(null==e?void 0:e.fingerprint)||null}async cleanup(){await c.cleanupExpiredSessions();let{e2eeStorage:e}=await Promise.resolve().then(r.bind(r,6812));await e.cleanupExpiredPreKeys()}async reset(){await c.reset(),this.isInitialized=!1}log(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];this.config.enableLogging&&console.log("[E2EE Service]",...t)}constructor(e){this.isInitialized=!1,this.config={apiBaseUrl:"/api",enableLogging:!1,...e}}}let y=null;var g=r(5947),h=r(7910),p=r(5105);let f=(0,p.A)("RefreshCw",[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]]);var w=r(7816);let m=(0,p.A)("XCircle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]]),x=(0,p.A)("Key",[["circle",{cx:"7.5",cy:"15.5",r:"5.5",key:"yqb3hr"}],["path",{d:"m21 2-9.6 9.6",key:"1j0ho8"}],["path",{d:"m15.5 7.5 3 3L22 7l-3-3",key:"1rn1fs"}]]);var b=r(9708);let S=(0,p.A)("Unlock",[["rect",{width:"18",height:"11",x:"3",y:"11",rx:"2",ry:"2",key:"1w4ew1"}],["path",{d:"M7 11V7a5 5 0 0 1 9.9-1",key:"1mm8w8"}]]);function v(){let[e,t]=function(e){let{currentUserId:t,enableLogging:r=!1,autoInitialize:s=!0}=e,[a,n]=(0,i.useState)({isInitialized:!1,isInitializing:!1,error:null,myFingerprint:null}),o=(0,i.useRef)(null),c=(0,i.useCallback)(async()=>{if(!a.isInitialized&&!a.isInitializing){n(e=>({...e,isInitializing:!0,error:null}));try{var e;let s=(e={currentUserId:t,enableLogging:r},y||(y=new u(e)),y);o.current=s,await s.initialize();let i=await s.getMyFingerprint();n(e=>({...e,isInitialized:!0,isInitializing:!1,myFingerprint:i})),console.log("E2EE initialized successfully")}catch(t){let e=t instanceof Error?t.message:"Failed to initialize E2EE";n(t=>({...t,isInitializing:!1,error:e})),console.error("E2EE initialization failed:",t)}}},[t,r,a.isInitialized,a.isInitializing]),l=(0,i.useCallback)(async e=>{if(!o.current)throw Error("E2EE service not initialized");try{return await o.current.establishSession(e)}catch(t){throw console.error("Failed to establish session with ".concat(e,":"),t),t}},[]),d=(0,i.useCallback)(async(e,t)=>{if(!o.current)throw Error("E2EE service not initialized");try{return await o.current.encryptAndSendText(e,t)}catch(t){throw console.error("Failed to encrypt text for ".concat(e,":"),t),t}},[]),g=(0,i.useCallback)(async(e,t)=>{if(!o.current)throw Error("E2EE service not initialized");try{return await o.current.encryptAndSendMedia(e,t)}catch(t){throw console.error("Failed to encrypt media for ".concat(e,":"),t),t}},[]),h=(0,i.useCallback)(async(e,t)=>{if(!o.current)return{plaintext:"",isValid:!1,error:"E2EE service not initialized"};try{return await o.current.decryptTextMessage(e,t)}catch(t){return console.error("Failed to decrypt text from ".concat(e,":"),t),{plaintext:"",isValid:!1,error:t instanceof Error?t.message:"Decryption failed"}}},[]),p=(0,i.useCallback)(async(e,t)=>{if(!o.current)return{plaintext:new ArrayBuffer(0),isValid:!1,error:"E2EE service not initialized"};try{return await o.current.decryptMediaMessage(e,t)}catch(t){return console.error("Failed to decrypt media from ".concat(e,":"),t),{plaintext:new ArrayBuffer(0),isValid:!1,error:t instanceof Error?t.message:"Media decryption failed"}}},[]),f=(0,i.useCallback)(async(e,t)=>{if(!o.current)return!1;try{return await o.current.verifyPeerFingerprint(e,t)}catch(t){return console.error("Failed to verify fingerprint for ".concat(e,":"),t),!1}},[]),w=(0,i.useCallback)(async e=>{if(!o.current)return null;try{return await o.current.getSessionInfo(e)}catch(t){return console.error("Failed to get session info for ".concat(e,":"),t),null}},[]),m=(0,i.useCallback)(async e=>{if(!o.current)return!1;try{return await o.current.rotateSessionKey(e)}catch(t){return console.error("Failed to rotate session key for ".concat(e,":"),t),!1}},[]),x=(0,i.useCallback)(async()=>{if(o.current)try{await o.current.reset()}catch(e){console.error("Failed to reset E2EE service:",e)}y=null,o.current=null,n({isInitialized:!1,isInitializing:!1,error:null,myFingerprint:null})},[]);return(0,i.useEffect)(()=>{s&&t&&!a.isInitialized&&!a.isInitializing&&c()},[s,t,a.isInitialized,a.isInitializing,c]),(0,i.useEffect)(()=>()=>{},[]),[a,{initialize:c,establishSession:l,encryptText:d,encryptMedia:g,decryptText:h,decryptMedia:p,verifyFingerprint:f,getSessionInfo:w,rotateSessionKey:m,reset:x}]}({currentUserId:"1",enableLogging:!0,autoInitialize:!0}),[r,a]=(0,i.useState)("Hello, E2EE!"),[n,o]=(0,i.useState)(null),[c,l]=(0,i.useState)(""),[d,p]=(0,i.useState)([]),v=async()=>{let s=[];try{e.isInitialized?s.push({test:"E2EE 初始化",result:!0,message:"端到端加密系统已成功初始化"}):s.push({test:"E2EE 初始化",result:!1,message:"端到端加密系统初始化失败"}),e.myFingerprint?s.push({test:"密钥指纹",result:!0,message:"指纹生成成功: ".concat(e.myFingerprint.slice(0,16),"...")}):s.push({test:"密钥指纹",result:!1,message:"密钥指纹生成失败"});try{let e=await t.establishSession("2");s.push({test:"会话建立",result:!0,message:"会话建立成功，指纹: ".concat(e.fingerprint.slice(0,16),"...")})}catch(e){s.push({test:"会话建立",result:!1,message:"会话建立失败: ".concat(e instanceof Error?e.message:"未知错误")})}try{let e=await t.encryptText("2",r);o(e),s.push({test:"消息加密",result:!0,message:"消息加密成功，算法: ".concat(e.algorithm)})}catch(e){s.push({test:"消息加密",result:!1,message:"消息加密失败: ".concat(e instanceof Error?e.message:"未知错误")})}if(n)try{let e=await t.decryptText("2",n);l(e.plaintext),s.push({test:"消息解密",result:e.isValid,message:e.isValid?'消息解密成功: "'.concat(e.plaintext,'"'):"消息解密失败: ".concat(e.error)})}catch(e){s.push({test:"消息解密",result:!1,message:"消息解密失败: ".concat(e instanceof Error?e.message:"未知错误")})}try{let e=await t.getSessionInfo("2");e?s.push({test:"会话信息",result:!0,message:"会话状态: ".concat(e.isEstablished?"已建立":"未建立")}):s.push({test:"会话信息",result:!1,message:"无法获取会话信息"})}catch(e){s.push({test:"会话信息",result:!1,message:"获取会话信息失败: ".concat(e instanceof Error?e.message:"未知错误")})}}catch(e){s.push({test:"测试执行",result:!1,message:"测试执行失败: ".concat(e instanceof Error?e.message:"未知错误")})}p(s)};return(0,i.useEffect)(()=>{e.isInitialized&&v()},[e.isInitialized]),(0,s.jsx)("div",{className:"min-h-screen bg-gray-50 p-6",children:(0,s.jsxs)("div",{className:"max-w-4xl mx-auto",children:[(0,s.jsxs)("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6",children:[(0,s.jsxs)("div",{className:"flex items-center space-x-3 mb-4",children:[(0,s.jsx)(h.A,{className:"w-8 h-8 text-blue-500"}),(0,s.jsxs)("div",{children:[(0,s.jsx)("h1",{className:"text-2xl font-bold text-gray-900",children:"E2EE 端到端加密测试"}),(0,s.jsx)("p",{className:"text-gray-600",children:"验证端到端加密系统的各项功能"})]})]}),(0,s.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,s.jsxs)("div",{className:"flex items-center space-x-2",children:[e.isInitializing?(0,s.jsx)(f,{className:"w-4 h-4 text-yellow-500 animate-spin"}):e.isInitialized?(0,s.jsx)(w.A,{className:"w-4 h-4 text-green-500"}):(0,s.jsx)(m,{className:"w-4 h-4 text-red-500"}),(0,s.jsx)("span",{className:"text-sm font-medium",children:e.isInitializing?"初始化中...":e.isInitialized?"已初始化":"未初始化"})]}),e.myFingerprint&&(0,s.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,s.jsx)(x,{className:"w-4 h-4 text-gray-500"}),(0,s.jsxs)("span",{className:"text-sm text-gray-600",children:["指纹: ",(0,s.jsxs)("code",{className:"bg-gray-100 px-1 rounded",children:[e.myFingerprint.slice(0,16),"..."]})]})]})]})]}),(0,s.jsxs)("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6",children:[(0,s.jsx)("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:"测试控制"}),(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"测试消息"}),(0,s.jsx)("input",{type:"text",value:r,onChange:e=>a(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"输入要加密的测试消息"})]}),(0,s.jsxs)("div",{className:"flex space-x-3",children:[(0,s.jsx)("button",{onClick:v,disabled:!e.isInitialized||e.isInitializing,className:"px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors",children:"运行测试"}),(0,s.jsx)("button",{onClick:()=>t.initialize(),disabled:e.isInitializing||e.isInitialized,className:"px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors",children:"重新初始化"}),(0,s.jsx)("button",{onClick:()=>t.reset(),className:"px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors",children:"重置"})]})]})]}),(0,s.jsxs)("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6",children:[(0,s.jsx)("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:"测试结果"}),(0,s.jsx)("div",{className:"space-y-3",children:d.map((e,t)=>(0,s.jsxs)(g.P.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.1*t},className:"flex items-center space-x-3 p-3 rounded-md ".concat(e.result?"bg-green-50 border border-green-200":"bg-red-50 border border-red-200"),children:[e.result?(0,s.jsx)(w.A,{className:"w-5 h-5 text-green-500"}):(0,s.jsx)(m,{className:"w-5 h-5 text-red-500"}),(0,s.jsxs)("div",{children:[(0,s.jsx)("div",{className:"font-medium text-gray-900",children:e.test}),(0,s.jsx)("div",{className:"text-sm text-gray-600",children:e.message})]})]},t))})]}),(n||c)&&(0,s.jsxs)("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-6",children:[(0,s.jsx)("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:"加密/解密结果"}),(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[n&&(0,s.jsxs)("div",{children:[(0,s.jsxs)("h3",{className:"text-md font-medium text-gray-900 mb-2 flex items-center space-x-2",children:[(0,s.jsx)(b.A,{className:"w-4 h-4"}),(0,s.jsx)("span",{children:"加密结果"})]}),(0,s.jsxs)("div",{className:"bg-gray-50 p-3 rounded-md",children:[(0,s.jsxs)("div",{className:"text-sm text-gray-600 mb-2",children:["算法: ",n.algorithm]}),(0,s.jsxs)("div",{className:"text-sm text-gray-600 mb-2",children:["计数器: ",n.counter]}),(0,s.jsxs)("div",{className:"text-sm text-gray-600 mb-2",children:["IV: ",n.iv.slice(0,16),"..."]}),(0,s.jsxs)("div",{className:"text-sm text-gray-600",children:["密文: ",n.ciphertext.slice(0,50),"..."]})]})]}),c&&(0,s.jsxs)("div",{children:[(0,s.jsxs)("h3",{className:"text-md font-medium text-gray-900 mb-2 flex items-center space-x-2",children:[(0,s.jsx)(S,{className:"w-4 h-4"}),(0,s.jsx)("span",{children:"解密结果"})]}),(0,s.jsx)("div",{className:"bg-gray-50 p-3 rounded-md",children:(0,s.jsxs)("div",{className:"text-sm text-gray-600",children:['明文: "',c,'"']})})]})]})]}),e.error&&(0,s.jsxs)("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:[(0,s.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,s.jsx)(m,{className:"w-5 h-5 text-red-500"}),(0,s.jsx)("span",{className:"font-medium text-red-700",children:"错误信息"})]}),(0,s.jsx)("p",{className:"text-red-600 mt-2",children:e.error})]})]})})}},7816:(e,t,r)=>{"use strict";r.d(t,{A:()=>s});let s=(0,r(5105).A)("CheckCircle",[["path",{d:"M22 11.08V12a10 10 0 1 1-5.93-9.14",key:"g774vq"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]])},9708:(e,t,r)=>{"use strict";r.d(t,{A:()=>s});let s=(0,r(5105).A)("Lock",[["rect",{width:"18",height:"11",x:"3",y:"11",rx:"2",ry:"2",key:"1w4ew1"}],["path",{d:"M7 11V7a5 5 0 0 1 10 0v4",key:"fwvmzm"}]])},9942:(e,t,r)=>{"use strict";function s(e){let t=new Uint8Array(e),r="";for(let e=0;e<t.byteLength;e++)r+=String.fromCharCode(t[e]);return btoa(r)}function i(e){let t=atob(e),r=new Uint8Array(t.length);for(let e=0;e<t.length;e++)r[e]=t.charCodeAt(e);return r.buffer}function a(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];let s=new Uint8Array(t.reduce((e,t)=>e+t.byteLength,0)),i=0;for(let e of t)s.set(new Uint8Array(e),i),i+=e.byteLength;return s.buffer}function n(e){let t=new Uint8Array(e);return crypto.getRandomValues(t),t}async function o(){return await crypto.subtle.generateKey({name:"ECDH",namedCurve:"P-256"},!0,["deriveKey","deriveBits"])}async function c(){return await crypto.subtle.generateKey({name:"ECDH",namedCurve:"P-256"},!0,["deriveKey","deriveBits"])}async function l(e){return await crypto.subtle.exportKey("jwk",e)}async function d(e){return await crypto.subtle.exportKey("jwk",e)}async function u(e){return await crypto.subtle.importKey("jwk",e,{name:"ECDH",namedCurve:"P-256"},!0,[])}async function y(e){return await crypto.subtle.importKey("jwk",e,{name:"ECDH",namedCurve:"P-256"},!0,["deriveKey","deriveBits"])}async function g(e,t){return await crypto.subtle.deriveBits({name:"ECDH",public:t},e,256)}async function h(e,t,r){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:32,i=await crypto.subtle.importKey("raw",e,"HKDF",!1,["deriveBits"]);return await crypto.subtle.deriveBits({name:"HKDF",hash:"SHA-256",salt:t,info:new TextEncoder().encode(r)},i,8*s)}async function p(e,t,r,s){let i=await crypto.subtle.importKey("raw",e,{name:"AES-GCM"},!1,["encrypt"]),a=new Uint8Array(r),n=new Uint8Array(t),o=s?new Uint8Array(s):void 0;return new Uint8Array(await crypto.subtle.encrypt({name:"AES-GCM",iv:a,additionalData:o},i,n))}async function f(e,t,r,s){let i=await crypto.subtle.importKey("raw",e,{name:"AES-GCM"},!1,["decrypt"]),a=new Uint8Array(r),n=new Uint8Array(t),o=s?new Uint8Array(s):void 0;return new Uint8Array(await crypto.subtle.decrypt({name:"AES-GCM",iv:a,additionalData:o},i,n))}async function w(e){let t=await l(e),r=new TextEncoder().encode(JSON.stringify(t));return s(await crypto.subtle.digest("SHA-256",r)).slice(0,16)}async function m(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"encrypt",s="message-".concat(r,"-").concat(t);return await h(e,new ArrayBuffer(0),s,32)}async function x(e,t){return await h(e,new ArrayBuffer(0),"media-".concat(t),32)}r.d(t,{G5:()=>p,GR:()=>y,Gg:()=>n,Hi:()=>g,KG:()=>u,Ms:()=>i,NA:()=>a,Yi:()=>s,c2:()=>c,dZ:()=>o,ds:()=>l,lI:()=>x,oH:()=>m,sM:()=>h,sQ:()=>f,xu:()=>d,zJ:()=>w})}},e=>{e.O(0,[56,441,493,358],()=>e(e.s=6228)),_N_E=e.O()}]);