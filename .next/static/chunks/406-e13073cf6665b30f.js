"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[406],{1526:(e,t,s)=>{s.d(t,{x:()=>n});var a=s(9942);class i{async enable(e){try{this.updateStatus({isEstablishing:!0,error:void 0});let t=this.generateSessionId(),s=await this.generateSharedKey(),a={id:t,participants:e,sharedKey:s,createdAt:new Date,lastActivity:new Date,messageCount:0,isActive:!0};return this.sessions.set(t,a),this.updateStatus({isEnabled:!0,isEstablishing:!1,sessionId:t,lastActivity:new Date}),console.log("\uD83D\uDD10 端到端加密已启用"),t}catch(e){throw this.updateStatus({isEstablishing:!1,error:e instanceof Error?e.message:"启用加密失败"}),e}}disable(){this.sessions.clear(),this.updateStatus({isEnabled:!1,isEstablishing:!1,sessionId:void 0,error:void 0}),console.log("\uD83D\uDD13 端到端加密已禁用")}async encryptMessage(e,t,s){let i=this.sessions.get(e);if(!i||!i.isActive)throw Error("加密会话不存在或已失效");try{let n=(0,a.Gg)(12),r=new TextEncoder().encode(t),c=await (0,a.G5)(i.sharedKey,r,n);return i.messageCount++,i.lastActivity=new Date,{sessionId:e,ciphertext:(0,a.Yi)(c.buffer.slice(c.byteOffset,c.byteOffset+c.byteLength)),iv:(0,a.Yi)(n.buffer.slice(n.byteOffset,n.byteOffset+n.byteLength)),timestamp:Date.now(),messageId:this.generateMessageId(),senderId:s}}catch(e){throw Error("消息加密失败: ".concat(e instanceof Error?e.message:"未知错误"))}}async decryptMessage(e){let t=this.sessions.get(e.sessionId);if(!t||!t.isActive)throw Error("加密会话不存在或已失效");try{let s=(0,a.Ms)(e.ciphertext),i=(0,a.Ms)(e.iv),n=await (0,a.sQ)(t.sharedKey,new Uint8Array(s),new Uint8Array(i));return t.lastActivity=new Date,new TextDecoder().decode(n)}catch(e){throw Error("消息解密失败: ".concat(e instanceof Error?e.message:"未知错误"))}}getStatus(){return{...this.status}}subscribe(e){return this.listeners.add(e),()=>this.listeners.delete(e)}isEncryptedMessage(e){return e&&"object"==typeof e&&e.sessionId&&e.ciphertext&&e.iv}getActiveSessions(){return Array.from(this.sessions.values()).filter(e=>e.isActive)}cleanupExpiredSessions(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:864e5,t=Date.now();for(let[s,a]of this.sessions.entries())t-a.lastActivity.getTime()>e&&(a.isActive=!1,console.log("\uD83D\uDDD1️ 清理过期会话"))}updateStatus(e){this.status={...this.status,...e},this.listeners.forEach(e=>e(this.status))}generateSessionId(){return"session_".concat(Date.now(),"_").concat(Math.random().toString(36).substr(2,9))}generateMessageId(){return"msg_".concat(Date.now(),"_").concat(Math.random().toString(36).substr(2,9))}async generateSharedKey(){let e=(0,a.Gg)(32),t=new Uint8Array(e.length);return t.set(e),t.buffer}constructor(){this.sessions=new Map,this.status={isEnabled:!1,isEstablishing:!1},this.listeners=new Set}}let n=new i},4408:(e,t,s)=>{s.d(t,{cn:()=>n});var a=s(2821),i=s(5889);function n(){for(var e=arguments.length,t=Array(e),s=0;s<e;s++)t[s]=arguments[s];return(0,i.QP)((0,a.$)(t))}},6184:(e,t,s)=>{s.d(t,{f:()=>n});var a=s(2115),i=s(1526);function n(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{participants:t=[],autoEnable:s=!1}=e,[n,r]=(0,a.useState)(i.x.getStatus());(0,a.useEffect)(()=>i.x.subscribe(r),[]),(0,a.useEffect)(()=>{s&&t.length>0&&!n.isEnabled&&!n.isEstablishing&&c()},[s,t,n.isEnabled,n.isEstablishing]);let c=(0,a.useCallback)(async()=>{if(0===t.length)throw Error("需要指定参与者才能启用加密");try{await i.x.enable(t)}catch(e){throw console.error("启用加密失败:",e),e}},[t]),o=(0,a.useCallback)(()=>{i.x.disable()},[]),l=(0,a.useCallback)(async(e,t)=>{if(!n.isEnabled||!n.sessionId)throw Error("加密未启用");return await i.x.encryptMessage(n.sessionId,e,t)},[n.isEnabled,n.sessionId]),d=(0,a.useCallback)(async e=>await i.x.decryptMessage(e),[]),u=(0,a.useCallback)(e=>i.x.isEncryptedMessage(e),[]);return{isEnabled:n.isEnabled,isEstablishing:n.isEstablishing,...void 0!==n.sessionId?{sessionId:n.sessionId}:{},...void 0!==n.error?{error:n.error}:{},...void 0!==n.lastActivity?{lastActivity:n.lastActivity}:{},enable:c,disable:o,encryptMessage:l,decryptMessage:d,isEncryptedMessage:u}}},7975:(e,t,s)=>{s.d(t,{A:()=>y,P:()=>h});var a=s(5155),i=s(5947),n=s(1152),r=s(919),c=s(1078),o=s(7816),l=s(7910),d=s(9708),u=s(4408);function y(e){let{isEnabled:t,isEstablishing:s,error:d,onToggle:y,className:h}=e;return(0,a.jsx)(n.N,{mode:"wait",children:(0,a.jsx)(i.P.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},transition:{duration:.2},className:(0,u.cn)("flex items-center justify-center px-3 py-2 rounded-lg border",t&&!d&&"bg-green-50 border-green-200",s&&"bg-blue-50 border-blue-200",d&&"bg-red-50 border-red-200",!t&&!s&&!d&&"bg-gray-50 border-gray-200",h),children:s?(0,a.jsxs)(i.P.div,{initial:{opacity:0},animate:{opacity:1},className:"flex items-center space-x-2 text-blue-600",children:[(0,a.jsx)(r.A,{className:"w-4 h-4 animate-spin"}),(0,a.jsx)("span",{className:"text-sm font-medium",children:"正在建立加密连接..."})]}):d?(0,a.jsxs)(i.P.div,{initial:{opacity:0},animate:{opacity:1},className:"flex items-center space-x-2 text-red-600",children:[(0,a.jsx)(c.A,{className:"w-4 h-4"}),(0,a.jsx)("span",{className:"text-sm font-medium",children:"加密连接失败"})]}):t?(0,a.jsxs)(i.P.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},className:"flex items-center space-x-2 text-green-600",children:[(0,a.jsx)(o.A,{className:"w-4 h-4"}),(0,a.jsx)("span",{className:"text-sm font-medium",children:"端到端加密已启用"})]}):(0,a.jsxs)(i.P.button,{initial:{opacity:0},animate:{opacity:1},whileHover:{scale:1.02},whileTap:{scale:.98},onClick:y,className:"flex items-center space-x-2 text-gray-600 hover:text-blue-600 transition-colors",children:[(0,a.jsx)(l.A,{className:"w-4 h-4"}),(0,a.jsx)("span",{className:"text-sm font-medium",children:"启用端到端加密"})]})},"".concat(t,"-").concat(s,"-").concat(d))})}function h(e){let{isEnabled:t,isEstablishing:s}=e;return(0,a.jsx)("div",{className:"flex items-center space-x-1",children:(0,a.jsx)(n.N,{mode:"wait",children:t?(0,a.jsxs)(i.P.div,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.8},className:"flex items-center space-x-1 text-green-600",children:[(0,a.jsx)(d.A,{className:"w-3 h-3"}),(0,a.jsx)("span",{className:"text-xs font-medium",children:"加密"})]},"enabled"):s?(0,a.jsxs)(i.P.div,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.8},className:"flex items-center space-x-1 text-blue-600",children:[(0,a.jsx)(r.A,{className:"w-3 h-3 animate-spin"}),(0,a.jsx)("span",{className:"text-xs font-medium",children:"连接中"})]},"establishing"):(0,a.jsxs)(i.P.div,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.8},className:"flex items-center space-x-1 text-gray-400",children:[(0,a.jsx)(l.A,{className:"w-3 h-3"}),(0,a.jsx)("span",{className:"text-xs font-medium",children:"未加密"})]},"disabled")})})}},9942:(e,t,s)=>{function a(e){let t=new Uint8Array(e),s="";for(let e=0;e<t.byteLength;e++)s+=String.fromCharCode(t[e]);return btoa(s)}function i(e){let t=atob(e),s=new Uint8Array(t.length);for(let e=0;e<t.length;e++)s[e]=t.charCodeAt(e);return s.buffer}function n(){for(var e=arguments.length,t=Array(e),s=0;s<e;s++)t[s]=arguments[s];let a=new Uint8Array(t.reduce((e,t)=>e+t.byteLength,0)),i=0;for(let e of t)a.set(new Uint8Array(e),i),i+=e.byteLength;return a.buffer}function r(e){let t=new Uint8Array(e);return crypto.getRandomValues(t),t}async function c(){return await crypto.subtle.generateKey({name:"ECDH",namedCurve:"P-256"},!0,["deriveKey","deriveBits"])}async function o(){return await crypto.subtle.generateKey({name:"ECDH",namedCurve:"P-256"},!0,["deriveKey","deriveBits"])}async function l(e){return await crypto.subtle.exportKey("jwk",e)}async function d(e){return await crypto.subtle.exportKey("jwk",e)}async function u(e){return await crypto.subtle.importKey("jwk",e,{name:"ECDH",namedCurve:"P-256"},!0,[])}async function y(e){return await crypto.subtle.importKey("jwk",e,{name:"ECDH",namedCurve:"P-256"},!0,["deriveKey","deriveBits"])}async function h(e,t){return await crypto.subtle.deriveBits({name:"ECDH",public:t},e,256)}async function m(e,t,s){let a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:32,i=await crypto.subtle.importKey("raw",e,"HKDF",!1,["deriveBits"]);return await crypto.subtle.deriveBits({name:"HKDF",hash:"SHA-256",salt:t,info:new TextEncoder().encode(s)},i,8*a)}async function p(e,t,s,a){let i=await crypto.subtle.importKey("raw",e,{name:"AES-GCM"},!1,["encrypt"]),n=new Uint8Array(s),r=new Uint8Array(t),c=a?new Uint8Array(a):void 0;return new Uint8Array(await crypto.subtle.encrypt({name:"AES-GCM",iv:n,additionalData:c},i,r))}async function f(e,t,s,a){let i=await crypto.subtle.importKey("raw",e,{name:"AES-GCM"},!1,["decrypt"]),n=new Uint8Array(s),r=new Uint8Array(t),c=a?new Uint8Array(a):void 0;return new Uint8Array(await crypto.subtle.decrypt({name:"AES-GCM",iv:n,additionalData:c},i,r))}async function b(e){let t=await l(e),s=new TextEncoder().encode(JSON.stringify(t));return a(await crypto.subtle.digest("SHA-256",s)).slice(0,16)}async function w(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"encrypt",a="message-".concat(s,"-").concat(t);return await m(e,new ArrayBuffer(0),a,32)}async function x(e,t){return await m(e,new ArrayBuffer(0),"media-".concat(t),32)}s.d(t,{G5:()=>p,GR:()=>y,Gg:()=>r,Hi:()=>h,KG:()=>u,Ms:()=>i,NA:()=>n,Yi:()=>a,c2:()=>o,dZ:()=>c,ds:()=>l,lI:()=>x,oH:()=>w,sM:()=>m,sQ:()=>f,xu:()=>d,zJ:()=>b})}}]);