"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[809],{1809:(e,t,s)=>{s.r(t),s.d(t,{default:()=>el});var a=s(5155),r=s(2115),o=s(1152),i=s(5947),n=s(368),l=s(9141),c=s(890),m=s(4747),d=s(7975);function y(e){let{conversation:t,onBack:s,isEncryptionEnabled:r=!1,isEncryptionEstablishing:o=!1,typingText:y,onStartCall:u,onStartVideo:g,onOpenInfo:x}=e,j=t.participants.filter(e=>"1"!==e.id),h=j[0],p=t.isGroup,w=p?"".concat(j.length," 人"):y||((null==h?void 0:h.isOnline)?"在线":"离线");return(0,a.jsx)(i.P.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},className:"glass-effect border-b border-gray-200/50 px-4 py-3 safe-area-inset-top",children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{className:"flex items-center space-x-3",children:[s&&(0,a.jsx)("button",{onClick:s,className:"icon-btn touch-feedback",children:(0,a.jsx)(n.A,{className:"w-5 h-5"})}),(0,a.jsxs)("div",{className:"flex items-center space-x-3",children:[(()=>{if(!p){var e;return(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-primary-400 to-primary-600 flex items-center justify-center text-white font-medium",children:(null==h||null==(e=h.name)?void 0:e.charAt(0))||"U"}),(null==h?void 0:h.isOnline)&&(0,a.jsx)("div",{className:"absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-green-500 rounded-full border-2 border-white"})]})}return(0,a.jsx)("div",{className:"flex -space-x-2",children:j.slice(0,3).map(e=>{var t;return(0,a.jsx)("div",{className:"w-8 h-8 rounded-full bg-gradient-to-br from-primary-400 to-primary-600 flex items-center justify-center text-white text-xs font-medium border-2 border-white",children:(null==(t=e.name)?void 0:t.charAt(0))||"U"},e.id)})})})(),(0,a.jsxs)("div",{children:[(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,a.jsx)("h1",{className:"font-semibold text-gray-900",children:t.isGroup?t.groupName:null==h?void 0:h.name}),(0,a.jsx)(d.P,{isEnabled:r,isEstablishing:o})]}),(0,a.jsx)("p",{className:"text-sm text-gray-500",children:w})]})]})]}),(0,a.jsxs)("div",{className:"flex items-center space-x-1",children:[(0,a.jsx)("button",{className:"icon-btn touch-feedback",onClick:u,children:(0,a.jsx)(l.A,{className:"w-5 h-5"})}),(0,a.jsx)("button",{className:"icon-btn touch-feedback",onClick:g,children:(0,a.jsx)(c.A,{className:"w-5 h-5"})}),(0,a.jsx)("button",{className:"icon-btn touch-feedback",onClick:x,children:(0,a.jsx)(m.A,{className:"w-5 h-5"})})]})]})})}var u=s(6074),g=s(5917),x=s(9152),j=s(9708),h=s(5426),p=s(4861),w=s(9347),b=s(1360),f=s(9021),k=s(7038),v=s(174);function N(e){return(0,f.A)(e)?(0,k.A)(e,"HH:mm"):(0,v.A)(e)?"昨天":(0,k.A)(e,"MM-dd")}function C(e,t){return(0,k.A)(e,"yyyy-MM-dd")===(0,k.A)(t,"yyyy-MM-dd")}var S=s(4408),A=s(1526);function M(e){let{message:t,isOwn:s,isLastInGroup:o,onImageClick:n,onReply:l,onDelete:c,onToggleStar:m,onRetry:d}=e,[y,u]=(0,r.useState)(!1),[f,k]=(0,r.useState)(!1),[v,C]=(0,r.useState)(null),M=async()=>{if("text"===t.type)try{await navigator.clipboard.writeText(t.content),u(!0),setTimeout(()=>u(!1),800)}catch(e){}},D=e=>{try{let{naturalWidth:t,naturalHeight:s}=e.currentTarget;C({width:t,height:s})}catch(e){console.error("Failed to load image:",e)}};return(0,a.jsxs)(i.P.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{duration:.2},className:(0,S.cn)("flex mb-1",s?"justify-end":"justify-start"),onContextMenu:e=>{e.preventDefault(),k(!0)},onPointerDown:e=>{if("touch"===e.pointerType){let t=setTimeout(()=>k(!0),500),s=()=>{clearTimeout(t)},a=e.currentTarget;a.addEventListener("pointerup",s,{once:!0}),a.addEventListener("pointercancel",s,{once:!0})}},children:[(0,a.jsxs)("div",{className:(0,S.cn)("flex flex-col max-w-[70%]",s?"items-end":"items-start"),children:[(0,a.jsx)(i.P.div,{animate:y?{scale:1.02}:{scale:1},transition:{duration:.12},className:(0,S.cn)("message-bubble",s?"sent":"received"),children:(()=>{if("image"===t.type){var e;return(0,a.jsxs)("div",{className:"relative cursor-pointer rounded-lg overflow-hidden max-w-xs",onClick:()=>n(t.content),children:[(0,a.jsx)("img",{src:t.content,alt:"消息图片",className:"w-full h-auto object-cover",loading:"lazy",onLoad:D}),"sending"===t.status&&(0,a.jsx)("div",{className:"absolute inset-0 bg-black/40 flex items-end",children:(0,a.jsx)("div",{className:"w-full h-1 bg-white/30",children:(0,a.jsx)("div",{className:"h-full bg-white",style:{width:"".concat(Math.max(5,null!=(e=t.uploadProgress)?e:0),"%")}})})}),"failed"===t.status&&(0,a.jsx)("div",{className:"absolute inset-0 bg-black/30 flex items-center justify-center",children:(0,a.jsx)("button",{className:"px-3 py-1 bg-white/90 rounded text-xs",onClick:e=>{e.stopPropagation();try{null==d||d(t.id)}catch(e){console.error("Failed to retry message:",e)}},children:"重试"})})]})}return A.x.isEncryptedMessage(t.content)?(0,a.jsxs)("div",{className:"flex items-center space-x-2 text-white/90",children:[(0,a.jsx)(j.A,{className:"w-4 h-4"}),(0,a.jsx)("span",{className:"text-sm",children:"\uD83D\uDD12 加密消息"})]}):(0,a.jsxs)("div",{className:"text-selection",onDoubleClick:M,children:[t.replyTo&&(0,a.jsxs)("div",{className:"mb-1 p-2 rounded-lg text-xs",style:{background:"rgba(0,0,0,.04)"},children:["回复 \xb7 #",t.replyTo]}),t.content]})})()}),o&&(0,a.jsxs)("div",{className:(0,S.cn)("flex items-center space-x-1 mt-1 text-xs text-gray-500",s?"justify-end":"justify-start"),children:[(0,a.jsx)("span",{children:N(t.timestamp)}),s&&(()=>{switch(t.status){case"sending":return(0,a.jsx)("div",{className:"flex items-center space-x-1",children:(0,a.jsx)("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-pulse"})});case"sent":return(0,a.jsx)(g.A,{className:"w-3 h-3 text-gray-400"});case"delivered":return(0,a.jsx)(x.A,{className:"w-3 h-3 text-gray-400"});case"read":return(0,a.jsx)(x.A,{className:"w-3 h-3 text-blue-500"});case"failed":return(0,a.jsx)("div",{className:"w-3 h-3 bg-red-500 rounded-full"});default:return null}})()]})]}),f&&(0,a.jsxs)("div",{className:"absolute z-20 mt-8 bg-white rounded-xl shadow border p-1 flex",style:{borderColor:"var(--border)"},onMouseLeave:()=>k(!1),children:[(0,a.jsx)("button",{className:"icon-btn",onClick:()=>{M(),k(!1)},title:"复制",children:(0,a.jsx)(h.A,{className:"w-4 h-4"})}),(0,a.jsx)("button",{className:"icon-btn",onClick:()=>{null==l||l(t.id),k(!1)},title:"回复",children:(0,a.jsx)(p.A,{className:"w-4 h-4"})}),(0,a.jsx)("button",{className:"icon-btn",onClick:()=>{null==m||m(t.id),k(!1)},title:"标星",children:(0,a.jsx)(w.A,{className:(0,S.cn)("w-4 h-4",t.starred&&"text-yellow-500")})}),(0,a.jsx)("button",{className:"icon-btn",onClick:()=>{null==c||c(t.id),k(!1)},title:"删除",children:(0,a.jsx)(b.A,{className:"w-4 h-4 text-red-500"})})]})]})}function D(e){let{messages:t,currentUserId:s,onImageClick:n,onReply:l,onDelete:c,onToggleStar:m,onRetry:d}=e,y=(0,r.useRef)(null),[g,x]=(0,r.useState)(!0),[j,h]=(0,r.useState)(0),[p,w]=(0,r.useState)(!1),b=(0,u.Te)({count:t.length,getScrollElement:()=>y.current,estimateSize:()=>64,overscan:5,measureElement:e=>(null==e?void 0:e.getBoundingClientRect().height)||64}),f=(0,r.useMemo)(()=>t.findIndex(e=>e.senderId!==s&&"read"!==e.status),[t,s]),k=(0,r.useCallback)(function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"smooth";y.current&&y.current.scrollTo({top:y.current.scrollHeight,behavior:e})},[]),v=(0,r.useCallback)(()=>{if(!y.current)return;let{scrollTop:e,scrollHeight:t,clientHeight:s}=y.current,a=t-e-s<100;x(a),g&&!a&&j>0&&w(!0)},[g,j]);(0,r.useEffect)(()=>{let e=y.current;if(e)return e.addEventListener("scroll",v),()=>e.removeEventListener("scroll",v)},[v]),(0,r.useEffect)(()=>{g?(k("auto"),h(0),w(!1)):h(e=>e+1)},[t.length,g,k]);let S=(0,r.useCallback)(()=>{k(),h(0),w(!1)},[k]);return(0,a.jsxs)("div",{className:"relative h-full overflow-hidden","data-testid":"msg-list",children:[(0,a.jsx)("div",{ref:y,className:"h-full overflow-y-auto scrollbar-hide px-4 py-2",children:(0,a.jsx)("div",{style:{height:"".concat(b.getTotalSize(),"px"),width:"100%",position:"relative"},children:(0,a.jsx)(o.N,{children:b.getVirtualItems().map(e=>{let r=t[e.index];return(0,a.jsx)("div",{ref:b.measureElement,"data-index":e.index,style:{position:"absolute",top:0,left:0,width:"100%",height:"".concat(e.size,"px"),transform:"translateY(".concat(e.start,"px)")},children:(0,a.jsx)(i.P.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{duration:.2},style:{height:"100%"},children:r&&((e,r)=>{var o,y,u;let g=r>0?t[r-1]:null,x=r<t.length-1?t[r+1]:null,j=!g||!C(e.timestamp,g.timestamp),h=!x||(o=x.timestamp,y=e.timestamp,u=x.senderId,!(u===e.senderId&&C(o,y)&&3e5>=Math.abs(o.getTime()-y.getTime())));return(0,a.jsxs)("div",{children:[f>=0&&r===f&&(0,a.jsxs)("div",{className:"flex items-center my-3",children:[(0,a.jsx)("div",{className:"flex-1 h-px bg-gray-200"}),(0,a.jsx)("span",{className:"mx-3 text-xs text-primary-600 bg-primary-50 px-2 py-0.5 rounded-full",children:"未读消息"}),(0,a.jsx)("div",{className:"flex-1 h-px bg-gray-200"})]}),j&&(0,a.jsx)(i.P.div,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},className:"flex justify-center my-4",children:(0,a.jsx)("div",{className:"bg-gray-200/50 px-3 py-1 rounded-full text-xs text-gray-600",children:N(e.timestamp)})}),(0,a.jsx)(M,{message:e,isOwn:e.senderId===s,isLastInGroup:h,onImageClick:n,currentUserId:s,onReply:e=>null==l?void 0:l(e),onDelete:e=>null==c?void 0:c(e),onToggleStar:e=>null==m?void 0:m(e),onRetry:e=>null==d?void 0:d(e)})]},e.id)})(r,e.index)})},e.key)})})})}),(0,a.jsx)(o.N,{children:p&&j>0&&(0,a.jsx)(i.P.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:20},className:"absolute bottom-4 left-1/2 transform -translate-x-1/2 z-10",children:(0,a.jsxs)("button",{onClick:S,className:"bg-primary-500 text-white px-4 py-2 rounded-full shadow-lg hover:bg-primary-600 transition-colors text-sm font-medium",children:[j," 条新消息"]})})}),(0,a.jsx)(o.N,{children:f>=0&&(0,a.jsx)(i.P.button,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},onClick:()=>b.scrollToIndex(f,{align:"start"}),className:"absolute top-4 right-4 bg-white/95 backdrop-blur px-3 py-1.5 rounded-full shadow text-xs text-gray-700 border",style:{borderColor:"var(--border)"},children:"跳至未读"})}),(0,a.jsx)(o.N,{children:!g&&(0,a.jsx)(i.P.button,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.8},onClick:()=>k(),className:"absolute bottom-4 right-4 w-10 h-10 bg-white/90 backdrop-blur-sm rounded-full shadow-lg hover:bg-white transition-colors flex items-center justify-center",children:(0,a.jsx)("svg",{className:"w-5 h-5 text-gray-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 14l-7 7m0 0l-7-7m7 7V3"})})})})]})}var I=s(4285),E=s(2196),P=s(725),O=s(8085);async function T(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},{maxWidth:s=1600,maxHeight:a=1600,quality:r=.85,format:o="jpeg"}=t;return new Promise((t,i)=>{let n=document.createElement("canvas"),l=n.getContext("2d"),c=new Image;c.onload=()=>{let{width:e,height:m}=c;e>s&&(m=m*s/e,e=s),m>a&&(e=e*a/m,m=a),n.width=e,n.height=m,null==l||l.drawImage(c,0,0,e,m),n.toBlob(e=>{e?t(e):i(Error("Failed to compress image"))},"image/".concat(o),r)},c.onerror=()=>i(Error("Failed to load image")),c.src=URL.createObjectURL(e)})}function L(e){URL.revokeObjectURL(e)}var U=s(4054);function R(e){let{value:t,onChange:s,onSend:o,onEmojiClick:n,onImageSelect:l,disabled:c=!1}=e,[m,d]=(0,r.useState)(!1),[y,u]=(0,r.useState)(!1),g=(0,r.useRef)(null);(0,r.useRef)(null);let{uploadImage:x}=function(){let[e,t]=(0,r.useState)(new Map),s=(0,r.useCallback)(async e=>{let s=["image/jpeg","image/png","image/gif","image/webp"].includes(e.type)?e.size>0xa00000?{valid:!1,error:"文件大小不能超过 10MB"}:{valid:!0}:{valid:!1,error:"不支持的文件格式，请选择 JPG、PNG、GIF 或 WebP 格式的图片"};if(!s.valid)throw Error(s.error);let a="".concat(Date.now(),"-").concat(Math.random().toString(36).substr(2,9)),r=URL.createObjectURL(e),o={id:a,file:e,preview:r,progress:0,status:"uploading"};t(e=>new Map(e).set(a,o));try{t(e=>{let t=new Map(e),s=t.get(a);return s&&t.set(a,{...s,progress:10}),t});let s=await T(e,{maxWidth:1600,maxHeight:1600,quality:.85,format:"jpeg"});t(e=>{let t=new Map(e),s=t.get(a);return s&&t.set(a,{...s,progress:50}),t}),await new Promise(e=>setTimeout(e,1e3)),t(e=>{let t=new Map(e),s=t.get(a);return s&&t.set(a,{...s,progress:100,status:"success"}),t});let o=URL.createObjectURL(s);return L(r),o}catch(e){throw t(t=>{let s=new Map(t),r=s.get(a);return r&&s.set(a,{...r,status:"error",error:e instanceof Error?e.message:"上传失败"}),s}),L(r),e}},[]),a=(0,r.useCallback)(async t=>{let a=e.get(t);if(!a)throw Error("Upload not found");return L(a.preview),s(a.file)},[e,s]),o=(0,r.useCallback)(s=>{let a=e.get(s);a&&(L(a.preview),t(e=>{let t=new Map(e);return t.delete(s),t}))},[e]),i=(0,r.useCallback)(()=>{e.forEach(e=>{L(e.preview)}),t(new Map)},[e]);return{uploads:Array.from(e.entries()).map(e=>{let[t,s]=e;return{...s,id:t}}),uploadImage:s,retryUpload:a,cancelUpload:o,clearUploads:i}}(),{getRootProps:j,getInputProps:h,isDragActive:p}=(0,U.VB)({accept:{"image/*":[".jpeg",".jpg",".png",".gif",".webp"]},multiple:!1,onDrop:e=>{e.length>0&&e[0]&&l(e[0])}}),w=(0,r.useCallback)(()=>{t.trim()&&o(t.trim())},[t,o]),b=(0,r.useCallback)(e=>{"Enter"!==e.key||e.shiftKey||y||(e.preventDefault(),w())},[w,y]),f=(0,r.useCallback)(e=>{s(e.target.value);let t=e.target;t.style.height="auto",t.style.height=Math.min(t.scrollHeight,120)+"px"},[s]);return(0,a.jsx)(i.P.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"glass-effect border-t border-gray-200/50 px-4 py-3 safe-area-inset-bottom",children:(0,a.jsxs)("div",{className:"flex items-end space-x-2",children:[(0,a.jsxs)("div",{...j(),className:"relative",children:[(0,a.jsx)("input",{...h()}),(0,a.jsx)("button",{type:"button",className:(0,S.cn)("icon-btn touch-feedback",p&&"bg-primary-100 text-primary-600"),"aria-label":"拖拽上传文件",children:(0,a.jsx)(I.A,{className:"w-5 h-5"})}),p&&(0,a.jsx)(i.P.div,{initial:{opacity:0},animate:{opacity:1},className:"absolute inset-0 bg-primary-500/20 rounded-full"})]}),(0,a.jsx)("button",{type:"button",onClick:()=>{var e;return null==(e=document.getElementById("image-input"))?void 0:e.click()},className:"icon-btn touch-feedback","aria-label":"选择图片",children:(0,a.jsx)(E.A,{className:"w-5 h-5"})}),(0,a.jsx)("input",{id:"image-input",type:"file",accept:"image/*",className:"hidden",onChange:e=>{var t;let s=null==(t=e.target.files)?void 0:t[0];s&&l(s)}}),(0,a.jsx)("div",{className:"flex-1 relative",children:(0,a.jsx)("textarea",{ref:g,value:t,onChange:f,onCompositionStart:()=>u(!0),onCompositionEnd:e=>{u(!1),s(e.currentTarget.value)},onKeyDown:b,onFocus:()=>d(!0),onBlur:()=>d(!1),placeholder:"输入消息...",className:"chat-input",rows:1,style:{minHeight:"44px",maxHeight:"120px"},"aria-label":"消息输入框","data-testid":"chat-input"})}),(0,a.jsx)("button",{type:"button",onClick:n,className:"icon-btn touch-feedback","aria-label":"打开表情选择器",children:(0,a.jsx)(P.A,{className:"w-5 h-5"})}),(0,a.jsx)(i.P.button,{type:"button",onClick:w,disabled:!t.trim(),whileTap:{scale:.95},className:(0,S.cn)("w-10 h-10 rounded-full flex items-center justify-center transition-all duration-200",t.trim()?"bg-primary-500 text-white hover:bg-primary-600":"bg-gray-200 text-gray-400 cursor-not-allowed"),"aria-label":"发送消息","data-testid":"send",children:(0,a.jsx)(O.A,{className:"w-5 h-5"})})]})})}var z=s(6651),F=s(5229);let G=[{id:"recent",name:"最近使用",icon:"\uD83D\uDD52",emojis:[]},{id:"smileys",name:"表情",icon:"\uD83D\uDE00",emojis:[{emoji:"\uD83D\uDE00",name:"笑脸",category:"smileys",keywords:["笑","开心","happy"]},{emoji:"\uD83D\uDE03",name:"大笑",category:"smileys",keywords:["大笑","joy"]},{emoji:"\uD83D\uDE04",name:"微笑",category:"smileys",keywords:["微笑","smile"]},{emoji:"\uD83D\uDE01",name:"露齿笑",category:"smileys",keywords:["露齿","grin"]},{emoji:"\uD83D\uDE05",name:"汗笑",category:"smileys",keywords:["汗","sweat"]},{emoji:"\uD83D\uDE02",name:"笑哭",category:"smileys",keywords:["笑哭","laugh"]},{emoji:"\uD83E\uDD23",name:"笑翻",category:"smileys",keywords:["笑翻","rofl"]},{emoji:"\uD83D\uDE0A",name:"害羞笑",category:"smileys",keywords:["害羞","blush"]},{emoji:"\uD83D\uDE07",name:"天使笑",category:"smileys",keywords:["天使","angel"]},{emoji:"\uD83D\uDE42",name:"微笑",category:"smileys",keywords:["微笑","slight"]},{emoji:"\uD83D\uDE43",name:"倒笑",category:"smileys",keywords:["倒笑","upside"]},{emoji:"\uD83D\uDE09",name:"眨眼",category:"smileys",keywords:["眨眼","wink"]},{emoji:"\uD83D\uDE0C",name:"满足",category:"smileys",keywords:["满足","relieved"]},{emoji:"\uD83D\uDE0D",name:"爱心眼",category:"smileys",keywords:["爱心","heart"]},{emoji:"\uD83E\uDD70",name:"爱心脸",category:"smileys",keywords:["爱心脸","love"]},{emoji:"\uD83D\uDE18",name:"飞吻",category:"smileys",keywords:["飞吻","kiss"]},{emoji:"\uD83D\uDE17",name:"亲吻",category:"smileys",keywords:["亲吻","kiss"]},{emoji:"\uD83D\uDE19",name:"微笑亲吻",category:"smileys",keywords:["微笑亲吻"]},{emoji:"\uD83D\uDE1A",name:"闭眼亲吻",category:"smileys",keywords:["闭眼亲吻"]},{emoji:"\uD83D\uDE0B",name:"吐舌",category:"smileys",keywords:["吐舌","tongue"]},{emoji:"\uD83D\uDE1B",name:"吐舌",category:"smileys",keywords:["吐舌","tongue"]},{emoji:"\uD83D\uDE1D",name:"挤眼吐舌",category:"smileys",keywords:["挤眼吐舌"]},{emoji:"\uD83D\uDE1C",name:"眨眼吐舌",category:"smileys",keywords:["眨眼吐舌"]},{emoji:"\uD83E\uDD2A",name:"疯狂",category:"smileys",keywords:["疯狂","crazy"]},{emoji:"\uD83E\uDD28",name:"怀疑",category:"smileys",keywords:["怀疑","skeptical"]},{emoji:"\uD83E\uDDD0",name:"侦探",category:"smileys",keywords:["侦探","detective"]},{emoji:"\uD83E\uDD13",name:"书呆子",category:"smileys",keywords:["书呆子","nerd"]},{emoji:"\uD83D\uDE0E",name:"酷",category:"smileys",keywords:["酷","cool"]},{emoji:"\uD83E\uDD29",name:"星星眼",category:"smileys",keywords:["星星眼","star"]},{emoji:"\uD83E\uDD73",name:"派对",category:"smileys",keywords:["派对","party"]},{emoji:"\uD83D\uDE0F",name:"得意",category:"smileys",keywords:["得意","smirk"]},{emoji:"\uD83D\uDE12",name:"不满",category:"smileys",keywords:["不满","unamused"]},{emoji:"\uD83D\uDE1E",name:"失望",category:"smileys",keywords:["失望","disappointed"]},{emoji:"\uD83D\uDE14",name:"忧郁",category:"smileys",keywords:["忧郁","pensive"]},{emoji:"\uD83D\uDE1F",name:"担心",category:"smileys",keywords:["担心","worried"]},{emoji:"\uD83D\uDE15",name:"困惑",category:"smileys",keywords:["困惑","confused"]},{emoji:"\uD83D\uDE41",name:"轻微皱眉",category:"smileys",keywords:["皱眉","slight"]},{emoji:"☹️",name:"皱眉",category:"smileys",keywords:["皱眉","frown"]},{emoji:"\uD83D\uDE23",name:"痛苦",category:"smileys",keywords:["痛苦","persevere"]},{emoji:"\uD83D\uDE16",name:"困惑",category:"smileys",keywords:["困惑","confounded"]},{emoji:"\uD83D\uDE2B",name:"疲惫",category:"smileys",keywords:["疲惫","tired"]},{emoji:"\uD83D\uDE29",name:"疲惫",category:"smileys",keywords:["疲惫","weary"]},{emoji:"\uD83E\uDD7A",name:"恳求",category:"smileys",keywords:["恳求","pleading"]},{emoji:"\uD83D\uDE22",name:"哭泣",category:"smileys",keywords:["哭泣","cry"]},{emoji:"\uD83D\uDE2D",name:"大哭",category:"smileys",keywords:["大哭","sob"]},{emoji:"\uD83D\uDE24",name:"得意",category:"smileys",keywords:["得意","triumph"]},{emoji:"\uD83D\uDE20",name:"生气",category:"smileys",keywords:["生气","angry"]},{emoji:"\uD83D\uDE21",name:"愤怒",category:"smileys",keywords:["愤怒","rage"]},{emoji:"\uD83E\uDD2C",name:"咒骂",category:"smileys",keywords:["咒骂","cursing"]},{emoji:"\uD83E\uDD2F",name:"爆炸头",category:"smileys",keywords:["爆炸头","exploding"]},{emoji:"\uD83D\uDE33",name:"震惊",category:"smileys",keywords:["震惊","flushed"]},{emoji:"\uD83E\uDD75",name:"热",category:"smileys",keywords:["热","hot"]},{emoji:"\uD83E\uDD76",name:"冷",category:"smileys",keywords:["冷","cold"]},{emoji:"\uD83D\uDE31",name:"尖叫",category:"smileys",keywords:["尖叫","scream"]},{emoji:"\uD83D\uDE28",name:"恐惧",category:"smileys",keywords:["恐惧","fearful"]},{emoji:"\uD83D\uDE30",name:"焦虑",category:"smileys",keywords:["焦虑","anxious"]},{emoji:"\uD83D\uDE25",name:"失望",category:"smileys",keywords:["失望","disappointed"]},{emoji:"\uD83D\uDE13",name:"冷汗",category:"smileys",keywords:["冷汗","sweat"]},{emoji:"\uD83E\uDD17",name:"拥抱",category:"smileys",keywords:["拥抱","hug"]},{emoji:"\uD83E\uDD14",name:"思考",category:"smileys",keywords:["思考","thinking"]},{emoji:"\uD83E\uDD2D",name:"偷笑",category:"smileys",keywords:["偷笑","giggle"]},{emoji:"\uD83E\uDD2B",name:"嘘",category:"smileys",keywords:["嘘","shushing"]},{emoji:"\uD83E\uDD25",name:"说谎",category:"smileys",keywords:["说谎","lying"]},{emoji:"\uD83D\uDE36",name:"无语",category:"smileys",keywords:["无语","no-mouth"]},{emoji:"\uD83D\uDE10",name:"中性",category:"smileys",keywords:["中性","neutral"]},{emoji:"\uD83D\uDE11",name:"面无表情",category:"smileys",keywords:["面无表情","expressionless"]},{emoji:"\uD83D\uDE2F",name:"惊讶",category:"smileys",keywords:["惊讶","hushed"]},{emoji:"\uD83D\uDE26",name:"皱眉",category:"smileys",keywords:["皱眉","frown"]},{emoji:"\uD83D\uDE27",name:"痛苦",category:"smileys",keywords:["痛苦","anguished"]},{emoji:"\uD83D\uDE2E",name:"张嘴",category:"smileys",keywords:["张嘴","open-mouth"]},{emoji:"\uD83D\uDE32",name:"震惊",category:"smileys",keywords:["震惊","astonished"]},{emoji:"\uD83D\uDE34",name:"睡觉",category:"smileys",keywords:["睡觉","sleeping"]},{emoji:"\uD83E\uDD24",name:"流口水",category:"smileys",keywords:["流口水","drooling"]},{emoji:"\uD83D\uDE2A",name:"困倦",category:"smileys",keywords:["困倦","sleepy"]},{emoji:"\uD83D\uDE35",name:"头晕",category:"smileys",keywords:["头晕","dizzy"]},{emoji:"\uD83E\uDD10",name:"拉链嘴",category:"smileys",keywords:["拉链嘴","zipper"]},{emoji:"\uD83E\uDD74",name:"醉",category:"smileys",keywords:["醉","woozy"]},{emoji:"\uD83D\uDE37",name:"口罩",category:"smileys",keywords:["口罩","mask"]},{emoji:"\uD83E\uDD12",name:"发烧",category:"smileys",keywords:["发烧","fever"]},{emoji:"\uD83E\uDD15",name:"受伤",category:"smileys",keywords:["受伤","injured"]},{emoji:"\uD83E\uDD22",name:"恶心",category:"smileys",keywords:["恶心","nauseated"]},{emoji:"\uD83E\uDD2E",name:"呕吐",category:"smileys",keywords:["呕吐","vomiting"]},{emoji:"\uD83E\uDD27",name:"打喷嚏",category:"smileys",keywords:["打喷嚏","sneezing"]},{emoji:"\uD83D\uDE08",name:"恶魔",category:"smileys",keywords:["恶魔","imp"]},{emoji:"\uD83D\uDC7F",name:"愤怒恶魔",category:"smileys",keywords:["愤怒恶魔","angry-imp"]},{emoji:"\uD83D\uDC79",name:"食人魔",category:"smileys",keywords:["食人魔","ogre"]},{emoji:"\uD83D\uDC7A",name:"天狗",category:"smileys",keywords:["天狗","goblin"]},{emoji:"\uD83E\uDD21",name:"小丑",category:"smileys",keywords:["小丑","clown"]},{emoji:"\uD83D\uDC7B",name:"鬼",category:"smileys",keywords:["鬼","ghost"]},{emoji:"\uD83D\uDC7D",name:"外星人",category:"smileys",keywords:["外星人","alien"]},{emoji:"\uD83D\uDC7E",name:"外星怪物",category:"smileys",keywords:["外星怪物","alien-monster"]},{emoji:"\uD83E\uDD16",name:"机器人",category:"smileys",keywords:["机器人","robot"]},{emoji:"\uD83D\uDE3A",name:"笑猫",category:"smileys",keywords:["笑猫","grinning-cat"]},{emoji:"\uD83D\uDE38",name:"笑猫",category:"smileys",keywords:["笑猫","grinning-cat"]},{emoji:"\uD83D\uDE39",name:"笑哭猫",category:"smileys",keywords:["笑哭猫","joy-cat"]},{emoji:"\uD83D\uDE3B",name:"爱心猫",category:"smileys",keywords:["爱心猫","heart-eyes-cat"]},{emoji:"\uD83D\uDE3C",name:"得意猫",category:"smileys",keywords:["得意猫","smirk-cat"]},{emoji:"\uD83D\uDE3D",name:"亲吻猫",category:"smileys",keywords:["亲吻猫","kissing-cat"]},{emoji:"\uD83D\uDE40",name:"尖叫猫",category:"smileys",keywords:["尖叫猫","scream-cat"]},{emoji:"\uD83D\uDE3F",name:"哭泣猫",category:"smileys",keywords:["哭泣猫","crying-cat"]},{emoji:"\uD83D\uDE3E",name:"生气猫",category:"smileys",keywords:["生气猫","pouting-cat"]}]},{id:"gestures",name:"手势",icon:"\uD83D\uDC4B",emojis:[{emoji:"\uD83D\uDC4B",name:"挥手",category:"gestures",keywords:["挥手","wave","再见"]},{emoji:"\uD83E\uDD1A",name:"举手",category:"gestures",keywords:["举手","raised-hand"]},{emoji:"\uD83D\uDD90️",name:"手掌",category:"gestures",keywords:["手掌","hand"]},{emoji:"✋",name:"举手",category:"gestures",keywords:["举手","raised-hand"]},{emoji:"\uD83D\uDD96",name:"瓦肯手势",category:"gestures",keywords:["瓦肯","vulcan"]},{emoji:"\uD83D\uDC4C",name:"OK",category:"gestures",keywords:["OK","ok"]},{emoji:"\uD83E\uDD0C",name:"捏",category:"gestures",keywords:["捏","pinched"]},{emoji:"\uD83E\uDD0F",name:"捏",category:"gestures",keywords:["捏","pinching"]},{emoji:"✌️",name:"胜利",category:"gestures",keywords:["胜利","victory","peace"]},{emoji:"\uD83E\uDD1E",name:"交叉手指",category:"gestures",keywords:["交叉手指","crossed"]},{emoji:"\uD83E\uDD1F",name:"摇滚",category:"gestures",keywords:["摇滚","rock"]},{emoji:"\uD83E\uDD18",name:"摇滚",category:"gestures",keywords:["摇滚","rock"]},{emoji:"\uD83E\uDD19",name:"电话",category:"gestures",keywords:["电话","call"]},{emoji:"\uD83D\uDC48",name:"左指",category:"gestures",keywords:["左指","point-left"]},{emoji:"\uD83D\uDC49",name:"右指",category:"gestures",keywords:["右指","point-right"]},{emoji:"\uD83D\uDC46",name:"上指",category:"gestures",keywords:["上指","point-up"]},{emoji:"\uD83D\uDD95",name:"中指",category:"gestures",keywords:["中指","middle-finger"]},{emoji:"\uD83D\uDC47",name:"下指",category:"gestures",keywords:["下指","point-down"]},{emoji:"☝️",name:"上指",category:"gestures",keywords:["上指","point-up"]},{emoji:"\uD83D\uDC4D",name:"点赞",category:"gestures",keywords:["点赞","thumbs-up","好"]},{emoji:"\uD83D\uDC4E",name:"点踩",category:"gestures",keywords:["点踩","thumbs-down","不好"]},{emoji:"\uD83D\uDC4A",name:"拳头",category:"gestures",keywords:["拳头","fist"]},{emoji:"✊",name:"拳头",category:"gestures",keywords:["拳头","fist"]},{emoji:"\uD83E\uDD1B",name:"左拳",category:"gestures",keywords:["左拳","left-fist"]},{emoji:"\uD83E\uDD1C",name:"右拳",category:"gestures",keywords:["右拳","right-fist"]},{emoji:"\uD83D\uDC4F",name:"鼓掌",category:"gestures",keywords:["鼓掌","clap","拍手"]},{emoji:"\uD83D\uDE4C",name:"举手",category:"gestures",keywords:["举手","raised-hands"]},{emoji:"\uD83D\uDC50",name:"张开手",category:"gestures",keywords:["张开手","open-hands"]},{emoji:"\uD83E\uDD32",name:"祈祷",category:"gestures",keywords:["祈祷","praying"]},{emoji:"\uD83E\uDD1D",name:"握手",category:"gestures",keywords:["握手","handshake"]},{emoji:"\uD83D\uDE4F",name:"祈祷",category:"gestures",keywords:["祈祷","pray","拜托"]},{emoji:"✍️",name:"写字",category:"gestures",keywords:["写字","writing"]},{emoji:"\uD83D\uDCAA",name:"肌肉",category:"gestures",keywords:["肌肉","muscle","力量"]},{emoji:"\uD83E\uDDBE",name:"机械臂",category:"gestures",keywords:["机械臂","mechanical-arm"]},{emoji:"\uD83E\uDDBF",name:"机械腿",category:"gestures",keywords:["机械腿","mechanical-leg"]},{emoji:"\uD83E\uDDB5",name:"腿",category:"gestures",keywords:["腿","leg"]},{emoji:"\uD83E\uDDB6",name:"脚",category:"gestures",keywords:["脚","foot"]},{emoji:"\uD83D\uDC42",name:"耳朵",category:"gestures",keywords:["耳朵","ear"]},{emoji:"\uD83E\uDDBB",name:"助听器",category:"gestures",keywords:["助听器","ear-with-hearing-aid"]},{emoji:"\uD83D\uDC43",name:"鼻子",category:"gestures",keywords:["鼻子","nose"]},{emoji:"\uD83E\uDDE0",name:"大脑",category:"gestures",keywords:["大脑","brain"]},{emoji:"\uD83E\uDEC0",name:"心脏",category:"gestures",keywords:["心脏","heart"]},{emoji:"\uD83E\uDEC1",name:"肺",category:"gestures",keywords:["肺","lungs"]},{emoji:"\uD83E\uDDB7",name:"牙齿",category:"gestures",keywords:["牙齿","tooth"]},{emoji:"\uD83E\uDDB4",name:"骨头",category:"gestures",keywords:["骨头","bone"]},{emoji:"\uD83D\uDC40",name:"眼睛",category:"gestures",keywords:["眼睛","eyes"]},{emoji:"\uD83D\uDC41️",name:"眼睛",category:"gestures",keywords:["眼睛","eye"]},{emoji:"\uD83D\uDC45",name:"舌头",category:"gestures",keywords:["舌头","tongue"]},{emoji:"\uD83D\uDC44",name:"嘴巴",category:"gestures",keywords:["嘴巴","mouth"]},{emoji:"\uD83D\uDC8B",name:"唇印",category:"gestures",keywords:["唇印","kiss-mark"]},{emoji:"\uD83E\uDE78",name:"血滴",category:"gestures",keywords:["血滴","blood"]}]},{id:"objects",name:"物品",icon:"\uD83D\uDCA1",emojis:[{emoji:"\uD83D\uDCA1",name:"灯泡",category:"objects",keywords:["灯泡","light-bulb","想法"]},{emoji:"\uD83D\uDD26",name:"手电筒",category:"objects",keywords:["手电筒","flashlight"]},{emoji:"\uD83D\uDD6F️",name:"蜡烛",category:"objects",keywords:["蜡烛","candle"]},{emoji:"\uD83E\uDE94",name:"油灯",category:"objects",keywords:["油灯","diya-lamp"]},{emoji:"\uD83D\uDCBB",name:"笔记本电脑",category:"objects",keywords:["笔记本电脑","laptop"]},{emoji:"\uD83D\uDDA5️",name:"台式电脑",category:"objects",keywords:["台式电脑","desktop"]},{emoji:"\uD83D\uDDA8️",name:"打印机",category:"objects",keywords:["打印机","printer"]},{emoji:"⌨️",name:"键盘",category:"objects",keywords:["键盘","keyboard"]},{emoji:"\uD83D\uDDB1️",name:"鼠标",category:"objects",keywords:["鼠标","mouse"]},{emoji:"\uD83D\uDDB2️",name:"轨迹球",category:"objects",keywords:["轨迹球","trackball"]},{emoji:"\uD83D\uDCBD",name:"软盘",category:"objects",keywords:["软盘","floppy-disk"]},{emoji:"\uD83D\uDCBE",name:"软盘",category:"objects",keywords:["软盘","floppy-disk"]},{emoji:"\uD83D\uDCBF",name:"光盘",category:"objects",keywords:["光盘","optical-disk"]},{emoji:"\uD83D\uDCC0",name:"DVD",category:"objects",keywords:["DVD","dvd"]},{emoji:"\uD83D\uDCF1",name:"手机",category:"objects",keywords:["手机","mobile-phone"]},{emoji:"\uD83D\uDCF2",name:"手机",category:"objects",keywords:["手机","mobile-phone"]},{emoji:"☎️",name:"电话",category:"objects",keywords:["电话","telephone"]},{emoji:"\uD83D\uDCDE",name:"电话",category:"objects",keywords:["电话","telephone"]},{emoji:"\uD83D\uDCDF",name:"寻呼机",category:"objects",keywords:["寻呼机","pager"]},{emoji:"\uD83D\uDCE0",name:"传真机",category:"objects",keywords:["传真机","fax"]},{emoji:"\uD83D\uDD0B",name:"电池",category:"objects",keywords:["电池","battery"]},{emoji:"\uD83D\uDD0C",name:"插头",category:"objects",keywords:["插头","electric-plug"]},{emoji:"\uD83D\uDCBB",name:"笔记本电脑",category:"objects",keywords:["笔记本电脑","laptop"]},{emoji:"\uD83D\uDDA5️",name:"台式电脑",category:"objects",keywords:["台式电脑","desktop"]},{emoji:"\uD83D\uDDA8️",name:"打印机",category:"objects",keywords:["打印机","printer"]},{emoji:"⌨️",name:"键盘",category:"objects",keywords:["键盘","keyboard"]},{emoji:"\uD83D\uDDB1️",name:"鼠标",category:"objects",keywords:["鼠标","mouse"]},{emoji:"\uD83D\uDDB2️",name:"轨迹球",category:"objects",keywords:["轨迹球","trackball"]},{emoji:"\uD83D\uDCBD",name:"软盘",category:"objects",keywords:["软盘","floppy-disk"]},{emoji:"\uD83D\uDCBE",name:"软盘",category:"objects",keywords:["软盘","floppy-disk"]},{emoji:"\uD83D\uDCBF",name:"光盘",category:"objects",keywords:["光盘","optical-disk"]},{emoji:"\uD83D\uDCC0",name:"DVD",category:"objects",keywords:["DVD","dvd"]},{emoji:"\uD83D\uDCF1",name:"手机",category:"objects",keywords:["手机","mobile-phone"]},{emoji:"\uD83D\uDCF2",name:"手机",category:"objects",keywords:["手机","mobile-phone"]},{emoji:"☎️",name:"电话",category:"objects",keywords:["电话","telephone"]},{emoji:"\uD83D\uDCDE",name:"电话",category:"objects",keywords:["电话","telephone"]},{emoji:"\uD83D\uDCDF",name:"寻呼机",category:"objects",keywords:["寻呼机","pager"]},{emoji:"\uD83D\uDCE0",name:"传真机",category:"objects",keywords:["传真机","fax"]},{emoji:"\uD83D\uDD0B",name:"电池",category:"objects",keywords:["电池","battery"]},{emoji:"\uD83D\uDD0C",name:"插头",category:"objects",keywords:["插头","electric-plug"]}]}],J=G.flatMap(e=>e.emojis),B="recent-emojis";function H(){try{return JSON.parse(localStorage.getItem(B)||"[]")}catch(e){return[]}}function V(e){let{onSelect:t}=e,[s,o]=(0,r.useState)("recent"),[n,l]=(0,r.useState)(""),[c,m]=(0,r.useState)([]);(0,r.useEffect)(()=>{m(H())},[]);let d=(()=>{var e;if(n){let e=n.toLowerCase();return J.filter(t=>t.name.toLowerCase().includes(e)||t.keywords.some(t=>t.toLowerCase().includes(e)))}return"recent"===s?c.map(e=>({emoji:e,name:"最近使用",category:"recent",keywords:[]})):(null==(e=G.find(e=>e.id===s))?void 0:e.emojis)||[]})();return(0,a.jsxs)(i.P.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.95},className:"bg-white rounded-2xl shadow-apple-lg border border-gray-200 max-h-96 overflow-hidden",children:[(0,a.jsx)("div",{className:"p-3 border-b border-gray-100",children:(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)(z.A,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),(0,a.jsx)("input",{type:"text",placeholder:"搜索表情...",value:n,onChange:e=>l(e.target.value),className:"w-full pl-10 pr-10 py-2 bg-gray-50 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent text-sm"}),n&&(0,a.jsx)("button",{onClick:()=>l(""),className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600",children:(0,a.jsx)(F.A,{className:"w-4 h-4"})})]})}),!n&&(0,a.jsx)("div",{className:"flex border-b border-gray-100",children:G.map(e=>(0,a.jsx)("button",{onClick:()=>o(e.id),className:(0,S.cn)("flex-1 py-2 text-center text-sm transition-colors",s===e.id?"text-primary-600 border-b-2 border-primary-600":"text-gray-500 hover:text-gray-700"),children:(0,a.jsx)("span",{className:"text-lg",children:e.icon})},e.id))}),(0,a.jsxs)("div",{className:"p-3 max-h-64 overflow-y-auto",children:[(0,a.jsx)("div",{className:"grid grid-cols-8 gap-1",children:d.map((e,s)=>(0,a.jsx)(i.P.button,{onClick:()=>(e=>{try{let t=H(),s=[e,...t.filter(t=>t!==e)].slice(0,30);localStorage.setItem(B,JSON.stringify(s))}catch(e){console.warn("Failed to save recent emoji:",e)}m(H()),t(e)})(e.emoji),whileHover:{scale:1.1},whileTap:{scale:.9},className:"w-8 h-8 flex items-center justify-center text-lg hover:bg-gray-100 rounded transition-colors",title:e.name,children:e.emoji},"".concat(e.emoji,"-").concat(s)))}),0===d.length&&(0,a.jsx)("div",{className:"text-center py-8 text-gray-500",children:(0,a.jsx)("p",{className:"text-sm",children:"没有找到相关表情"})})]})]})}var _=s(9867),K=s(7181),W=s(3141),Y=s(1629),X=s(4904);function q(e){let{imageUrl:t,onClose:s}=e,[n,l]=(0,r.useState)(1),[c,m]=(0,r.useState)(0),[d,y]=(0,r.useState)({x:0,y:0}),[u,g]=(0,r.useState)(!1),[x,j]=(0,r.useState)({x:0,y:0}),h=(0,r.useRef)(null);(0,r.useEffect)(()=>{let e=e=>{switch(e.key){case"Escape":s();break;case"=":case"+":e.preventDefault(),l(e=>Math.min(1.2*e,3));break;case"-":e.preventDefault(),l(e=>Math.max(e/1.2,.5));break;case"0":e.preventDefault(),p()}};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[s]);let p=()=>{l(1),m(0),y({x:0,y:0})},w=()=>{g(!1)},b=async()=>{if(navigator.share)try{await navigator.share({title:"分享图片",text:"查看这张图片",url:t})}catch(e){console.log("分享失败:",e)}else navigator.clipboard.writeText(t)};return(0,a.jsx)(o.N,{children:(0,a.jsxs)(i.P.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black/90 z-50 flex items-center justify-center",onClick:s,children:[(0,a.jsxs)("div",{className:"absolute top-4 right-4 flex items-center space-x-2 z-10",children:[(0,a.jsx)("button",{onClick:()=>{let e=document.createElement("a");e.href=t,e.download="image.jpg",document.body.appendChild(e),e.click(),document.body.removeChild(e)},className:"p-2 bg-white/20 backdrop-blur-sm rounded-full text-white hover:bg-white/30 transition-colors",children:(0,a.jsx)(_.A,{className:"w-5 h-5"})}),(0,a.jsx)("button",{onClick:b,className:"p-2 bg-white/20 backdrop-blur-sm rounded-full text-white hover:bg-white/30 transition-colors",children:(0,a.jsx)(K.A,{className:"w-5 h-5"})}),(0,a.jsx)("button",{onClick:p,className:"p-2 bg-white/20 backdrop-blur-sm rounded-full text-white hover:bg-white/30 transition-colors",children:(0,a.jsx)(W.A,{className:"w-5 h-5"})}),(0,a.jsx)("button",{onClick:s,className:"p-2 bg-white/20 backdrop-blur-sm rounded-full text-white hover:bg-white/30 transition-colors",children:(0,a.jsx)(F.A,{className:"w-5 h-5"})})]}),(0,a.jsxs)("div",{className:"absolute bottom-4 left-1/2 transform -translate-x-1/2 flex items-center space-x-2 z-10",children:[(0,a.jsx)("button",{onClick:()=>l(e=>Math.max(.5,e/1.2)),className:"p-2 bg-white/20 backdrop-blur-sm rounded-full text-white hover:bg-white/30 transition-colors",children:(0,a.jsx)(Y.A,{className:"w-5 h-5"})}),(0,a.jsxs)("span",{className:"text-white text-sm px-3 py-1 bg-white/20 backdrop-blur-sm rounded-full",children:[Math.round(100*n),"%"]}),(0,a.jsx)("button",{onClick:()=>l(e=>Math.min(3,1.2*e)),className:"p-2 bg-white/20 backdrop-blur-sm rounded-full text-white hover:bg-white/30 transition-colors",children:(0,a.jsx)(X.A,{className:"w-5 h-5"})})]}),(0,a.jsx)("div",{className:"relative w-full h-full flex items-center justify-center overflow-hidden",onMouseDown:e=>{n>1&&(g(!0),j({x:e.clientX-d.x,y:e.clientY-d.y}))},onMouseMove:e=>{u&&y({x:e.clientX-x.x,y:e.clientY-x.y})},onMouseUp:w,onMouseLeave:w,onWheel:e=>{e.preventDefault();let t=e.deltaY>0?.9:1.1;l(e=>Math.max(.5,Math.min(3,e*t)))},onClick:e=>e.stopPropagation(),children:(0,a.jsx)(i.P.img,{ref:h,src:t,alt:"查看图片",className:"max-w-full max-h-full object-contain",style:{cursor:n>1?u?"grabbing":"grab":"default",transform:"scale(".concat(n,") rotate(").concat(c,"deg) translate(").concat(d.x,"px, ").concat(d.y,"px)"),transformOrigin:"center"},drag:n>1,dragConstraints:{left:-100,right:100,top:-100,bottom:100},dragElastic:.1,dragMomentum:!1,onDoubleClick:()=>l(e=>1===e?2:1)})}),(0,a.jsx)("div",{className:"absolute bottom-20 left-1/2 transform -translate-x-1/2 text-white/60 text-sm text-center",children:(0,a.jsx)("p",{children:"双击缩放 • 滚轮缩放 • 拖拽移动 • ESC关闭"})})]})})}var Q=s(9058),Z=s(4266),$=s(2619),ee=s.n($);function et(e){let{conversations:t,currentUserId:s,activeId:o,onSelect:n}=e,[l,c]=(0,r.useState)(""),m=(0,r.useMemo)(()=>{let e=l.trim().toLowerCase();return t.filter(t=>{let a=t.participants.find(e=>e.id!==s),r=(t.isGroup?t.groupName:null==a?void 0:a.name)||"",o=t.lastMessagePreview||"";return r.toLowerCase().includes(e)||o.toLowerCase().includes(e)}).sort((e,t)=>{let s=+!!e.pinned,a=+!!t.pinned;if(s!==a)return a-s;let r=e.updatedAt?new Date(e.updatedAt).getTime():0;return(t.updatedAt?new Date(t.updatedAt).getTime():0)-r})},[t,s,l]);return(0,a.jsxs)("div",{className:"h-full flex flex-col border-r",style:{borderColor:"var(--border)"},children:[(0,a.jsx)("div",{className:"p-3",children:(0,a.jsxs)("div",{className:"flex items-center gap-2 bg-white rounded-xl border px-3 py-2 shadow-sm",style:{borderColor:"var(--border)"},children:[(0,a.jsx)(z.A,{className:"w-4 h-4 text-gray-400"}),(0,a.jsx)("input",{value:l,onChange:e=>c(e.target.value),placeholder:"搜索",className:"flex-1 outline-none bg-transparent text-sm"})]})}),(0,a.jsxs)("div",{className:"flex-1 overflow-y-auto",children:[m.map(e=>{var t,r;let l=e.participants.find(e=>e.id!==s),c=e.id===o;return(0,a.jsx)(ee(),{href:"/chats/".concat(e.id),className:"block",onClick:()=>n(e.id),children:(0,a.jsxs)(i.P.div,{initial:{opacity:0,y:6},animate:{opacity:1,y:0},transition:{duration:.15},className:(0,S.cn)("w-full px-3 py-2 flex items-center gap-3 hover:bg-gray-50",c&&"bg-gray-100"),children:[(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-primary-400 to-primary-600 flex items-center justify-center text-white font-medium",children:(e.isGroup?null==(t=e.groupName)?void 0:t.charAt(0):null==l||null==(r=l.name)?void 0:r.charAt(0))||"U"}),((null==l?void 0:l.isOnline)||e.isGroup)&&(0,a.jsx)("div",{className:"absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-green-500 rounded-full border-2 border-white"})]}),(0,a.jsxs)("div",{className:"flex-1 text-left",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("div",{className:"font-medium text-gray-900 truncate",children:e.isGroup?e.groupName:null==l?void 0:l.name}),e.pinned&&(0,a.jsx)(Q.A,{className:"w-3 h-3 text-gray-400"}),e.muted&&(0,a.jsx)(Z.A,{className:"w-3 h-3 text-gray-400"})]}),(0,a.jsx)("div",{className:"text-xs text-gray-500 truncate",children:e.lastMessagePreview||"开始聊天吧"})]}),(0,a.jsxs)("div",{className:"ml-auto flex flex-col items-end gap-1",children:[(0,a.jsx)("div",{className:"text-xs text-gray-400",children:e.updatedAt?new Date(e.updatedAt).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):""}),e.unreadCount>0&&(0,a.jsx)("div",{className:"min-w-[20px] px-1.5 h-5 rounded-full bg-primary-500 text-white text-[10px] flex items-center justify-center",children:e.unreadCount})]})]})},e.id)}),0===m.length&&(0,a.jsx)("div",{className:"px-4 py-6 text-sm text-gray-500",children:"未找到相关会话"})]})]})}var es=s(5998);let ea="chat:conv_notes";function er(e){let{open:t,onClose:s,conversation:n,currentUserId:l,onTogglePin:c,onToggleMute:m}=e,d=(0,r.useMemo)(()=>n.participants.filter(e=>e.id!==l),[n,l]),[y,u]=(0,r.useState)({}),g=y[n.id]||"";return(0,r.useEffect)(()=>{u(function(){try{return JSON.parse(localStorage.getItem(ea)||"{}")}catch(e){return{}}}())},[t]),(0,a.jsx)(o.N,{children:t&&(0,a.jsx)(i.P.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 z-40 bg-black/30",onClick:s,children:(0,a.jsxs)(i.P.aside,{initial:{x:"100%"},animate:{x:0},exit:{x:"100%"},transition:{type:"tween",duration:.2},className:"absolute right-0 top-0 bottom-0 w-[320px] bg-white shadow-xl border-l",style:{borderColor:"var(--border)"},onClick:e=>e.stopPropagation(),children:[(0,a.jsxs)("div",{className:"flex items-center justify-between p-4 border-b",style:{borderColor:"var(--border)"},children:[(0,a.jsx)("div",{className:"font-semibold text-gray-900",children:"会话信息"}),(0,a.jsx)("button",{onClick:s,className:"icon-btn",children:(0,a.jsx)(F.A,{className:"w-5 h-5"})})]}),(0,a.jsxs)("div",{className:"p-4 border-b",style:{borderColor:"var(--border)"},children:[(0,a.jsx)("div",{className:"text-sm font-medium text-gray-700 mb-2",children:"成员"}),(0,a.jsx)("div",{className:"space-y-2",children:d.map(e=>{var t;return(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("div",{className:"w-8 h-8 rounded-full bg-gradient-to-br from-primary-400 to-primary-600 flex items-center justify-center text-white text-xs font-medium",children:(null==(t=e.name)?void 0:t.charAt(0))||"U"}),(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-sm text-gray-900",children:e.name}),(0,a.jsx)("div",{className:"text-xs text-gray-500",children:e.isOnline?"在线":"离线"})]})]},e.id)})})]}),(0,a.jsxs)("div",{className:"p-4 border-b",style:{borderColor:"var(--border)"},children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,a.jsx)("div",{className:"text-sm font-medium text-gray-700",children:"备注"}),(0,a.jsx)("div",{className:"text-xs text-gray-400",children:"仅本机可见"})]}),(0,a.jsx)("textarea",{value:g,onChange:e=>(e=>{let t={...y,[n.id]:e};u(t);try{localStorage.setItem(ea,JSON.stringify(t))}catch(e){}})(e.target.value),placeholder:"添加一些对该对话的备注...",className:"w-full h-24 p-2 rounded border text-sm focus:outline-none focus:ring-2 focus:ring-primary-500",style:{borderColor:"var(--border)"}})]}),(0,a.jsxs)("div",{className:"p-4 space-y-3",children:[(0,a.jsxs)("button",{onClick:()=>{try{c(n.id,!n.pinned)}catch(e){console.error("Failed to toggle pin:",e)}},className:"w-full flex items-center gap-2 px-3 py-2 rounded border hover:bg-gray-50",style:{borderColor:"var(--border)"},children:[(0,a.jsx)(Q.A,{className:"w-4 h-4 text-gray-600"}),(0,a.jsx)("span",{className:"text-sm text-gray-800",children:n.pinned?"取消置顶":"置顶此会话"})]}),(0,a.jsxs)("button",{onClick:()=>m(n.id,!n.muted),className:"w-full flex items-center gap-2 px-3 py-2 rounded border hover:bg-gray-50",style:{borderColor:"var(--border)"},children:[n.muted?(0,a.jsx)(es.A,{className:"w-4 h-4 text-gray-600"}):(0,a.jsx)(Z.A,{className:"w-4 h-4 text-gray-600"}),(0,a.jsx)("span",{className:"text-sm text-gray-800",children:n.muted?"取消静音":"静音此会话"})]})]})]})})})}var eo=s(6184),ei=s(63),en=s(5704);function el(){let e="1"===en.env.NEXT_PUBLIC_E2E,t="undefined"!=typeof navigator&&!0===navigator.webdriver,s=e||t,n=(0,ei.useRouter)(),[l,c]=(0,r.useState)([]),[m,u]=(0,r.useState)({id:"1",name:"我",avatar:"/avatars/user1.jpg",isOnline:!0});(0,r.useEffect)(()=>{try{let e=localStorage.getItem("chat:user");if(e){let t=JSON.parse(e);u({id:t.id,name:t.name,isOnline:!0,isAdmin:!!t.isAdmin})}else if(s){let e={id:"e2e-user",name:"E2E用户",isAdmin:!1};localStorage.setItem("chat:user",JSON.stringify(e)),u({id:e.id,name:e.name,isOnline:!0,isAdmin:!1})}else n.replace("/login")}catch(e){console.error("Failed to load user data:",e)}},[s,n]);let[g,x]=(0,r.useState)([]);(0,r.useEffect)(()=>{let e=[{id:"1",participants:[{...m},{id:"2",name:"张三",isOnline:!0}],unreadCount:2,isGroup:!1,pinned:!1,lastMessagePreview:"苹果级体验真的很丝滑",updatedAt:new Date().toISOString()}];if(m.isAdmin){let t=[{id:"100",name:"管理员A",isOnline:!0,isAdmin:!0},{id:"101",name:"管理员B",isOnline:!1,isAdmin:!0},{...m}];e.push({id:"admin-group",participants:t,isGroup:!0,groupName:"管理员聊天室",unreadCount:0,muted:!1,pinned:!0,lastMessagePreview:"欢迎加入管理员群",updatedAt:new Date(Date.now()-18e5).toISOString()})}x(e)},[m]);let[j,h]=(0,r.useState)("1"),p=(0,r.useMemo)(()=>g.find(e=>e.id===j)||null,[g,j]),[w,b]=(0,r.useState)(!1),[f,k]=(0,r.useState)(null),[v,N]=(0,r.useState)(""),[C,S]=(0,r.useState)(!1),[A,M]=(0,r.useState)(void 0),[I,E]=(0,r.useState)(null),{isEnabled:P,isEstablishing:O,error:T,enable:L,disable:U,encryptMessage:z}=(0,eo.f)({participants:["1","2"],autoEnable:!s});(0,r.useEffect)(()=>{try{let e="chat:messages:".concat(j),t=localStorage.getItem(e);if(t){let e=JSON.parse(t).map(e=>({...e,timestamp:new Date(e.timestamp)}));c(e);return}}catch(e){console.error("Failed to load messages:",e)}let e=Date.now(),t=[{id:"1",content:"你好！欢迎使用极简聊天室 \uD83D\uDC4B",type:"text",senderId:"2",timestamp:new Date(e-12e5),status:"read"},{id:"2",content:"这个界面设计真的很棒",type:"text",senderId:"2",timestamp:new Date(e-114e4),status:"read"},{id:"3",content:"流畅度也很赞！",type:"text",senderId:"2",timestamp:new Date(e-108e4),status:"read"},{id:"4",content:"谢谢！我们确实花了很多心思",type:"text",senderId:"1",timestamp:new Date(e-6e5),status:"read"},{id:"5",content:"是的，采用了苹果级的设计理念，追求极致的流畅体验 \uD83C\uDF4E",type:"text",senderId:"2",timestamp:new Date(e-3e5),status:"read"},{id:"6",content:"每个细节都很用心",type:"text",senderId:"2",timestamp:new Date(e-1e3),status:"read"}];"admin-group"===j&&t.push({id:"sys-1",content:"这是管理员聊天室（演示）",type:"text",senderId:"100",timestamp:new Date(e-6e4),status:"read"}),c(t)},[j]),(0,r.useEffect)(()=>{try{let e="chat:messages:".concat(j);localStorage.setItem(e,JSON.stringify(l))}catch(e){console.error("Failed to persist messages:",e)}},[l,j]),(0,r.useEffect)(()=>{let e=setInterval(()=>{let e=g[Math.floor(Math.random()*g.length)];if(!e)return;let t=e.participants.find(e=>e.id!==m.id);t&&(e.id===j&&M("对方正在输入…"),setTimeout(()=>{if(e.id===j){M(void 0);let s={id:(Date.now()+Math.random()).toString(),content:"收到～",type:"text",senderId:t.id,timestamp:new Date,status:"read"};c(e=>[...e,s]),x(t=>t.map(t=>t.id===e.id?{...t,lastMessagePreview:"收到～",updatedAt:new Date().toISOString()}:t))}else x(t=>t.map(t=>t.id===e.id?{...t,lastMessagePreview:"收到～",updatedAt:new Date().toISOString(),unreadCount:(t.unreadCount||0)+1}:t))},2e3))},2e4);return()=>clearInterval(e)},[j,g,m.id]),(0,r.useEffect)(()=>{x(e=>e.map(e=>e.id===j?{...e,unreadCount:0}:e)),c(e=>e.map(e=>({...e,status:e.senderId!==m.id?"read":e.status})))},[j,m.id]);let F=async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"text";try{let a=e;if("text"===t&&P)try{let t=await z(e,m.id);a=JSON.stringify(t)}catch(e){console.error("加密失败:",e)}let r={id:Date.now().toString(),content:a,type:t,senderId:m.id,timestamp:new Date,status:"sending",...I?{replyTo:I}:{}};if(c(e=>[...e,r]),N(""),E(null),b(!1),setTimeout(()=>{c(e=>e.map(e=>e.id===r.id?{...e,status:"sent"}:e))},500),setTimeout(()=>{c(e=>e.map(e=>e.id===r.id?{...e,status:"delivered"}:e))},1200),setTimeout(()=>{c(e=>e.map(e=>e.id===r.id?{...e,status:"read"}:e))},2500),x(s=>s.map(s=>s.id===j?{...s,lastMessagePreview:"text"===t?e:"图片",updatedAt:new Date().toISOString(),unreadCount:0}:s)),"text"===t)try{let t=await fetch("/api/chat",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({messages:[{role:"user",content:e}]})});if(t.ok){var s;let e=await t.json(),a={id:(Date.now()+Math.random()).toString(),content:String(null!=(s=e.content)?s:"OK"),type:"text",senderId:"2",timestamp:new Date,status:"read"};c(e=>[...e,a]),x(e=>e.map(e=>e.id===j?{...e,lastMessagePreview:a.content,updatedAt:new Date().toISOString()}:e))}}catch(e){console.error("调用假模型失败",e)}}catch(e){console.error("发送消息失败:",e)}},G=async()=>{if(P)U();else try{await L()}catch(e){console.error("启用加密失败:",e)}};return(0,a.jsxs)("div",{className:"flex h-screen",style:{background:"var(--surface)"},"data-testid":"chat-root",children:[(0,a.jsx)("div",{className:"hidden md:flex w-72 flex-col",style:{background:"var(--bg)"},children:(0,a.jsx)(et,{conversations:g,currentUserId:m.id,activeId:j,onSelect:e=>{h(e),S(!1)}})}),(0,a.jsxs)("div",{className:"flex-1 flex flex-col",children:[(0,a.jsx)("div",{className:"px-4 py-2 border-b",style:{background:"var(--bg)",borderColor:"var(--border)"},children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsx)(d.A,{isEnabled:P,isEstablishing:O,error:null!=T?T:"",onToggle:G}),(0,a.jsx)("button",{className:"icon-btn",onClick:()=>S(!0),children:"详情"})]})}),p&&(0,a.jsx)(y,{conversation:p,isEncryptionEnabled:P,isEncryptionEstablishing:O,typingText:null!=A?A:"",onStartCall:()=>n.push("/call"),onStartVideo:()=>n.push("/call"),onOpenInfo:()=>S(!0)}),(0,a.jsx)("div",{className:"flex-1 overflow-hidden",children:(0,a.jsx)(D,{messages:l,currentUserId:m.id,onImageClick:k,onReply:e=>E(e),onDelete:e=>c(t=>t.filter(t=>t.id!==e)),onToggleStar:e=>c(t=>t.map(t=>t.id===e?{...t,starred:!t.starred}:t)),onRetry:e=>(e=>{let t=l.find(t=>t.id===e);if(!t)return;let s="upload-"+Date.now();c(t=>t.map(t=>t.id===e?{...t,id:s,status:"sending",uploadProgress:1}:t));let a=1,r=setInterval(()=>{a=Math.min(100,a+Math.round(20*Math.random())),c(e=>e.map(e=>e.id===s?{...e,uploadProgress:a}:e)),a>=100&&(clearInterval(r),F(t.content,"image"),c(e=>e.filter(e=>e.id!==s)))},300)})(e)})}),(0,a.jsxs)("div",{className:"relative",children:[I&&(0,a.jsxs)("div",{className:"px-4 py-2 text-xs text-gray-600 flex items-center justify-between border-b",style:{borderColor:"var(--border)"},children:[(0,a.jsxs)("div",{children:["回复 \xb7 #",I]}),(0,a.jsx)("button",{className:"text-primary-600",onClick:()=>E(null),children:"取消"})]}),(0,a.jsx)(R,{value:v,onChange:N,onSend:F,onEmojiClick:()=>b(!w),onImageSelect:e=>{let t=new FileReader;t.onload=e=>{var t;let s=null==(t=e.target)?void 0:t.result,a="upload-"+Date.now(),r={id:a,content:s,type:"image",senderId:m.id,timestamp:new Date,status:"sending",uploadProgress:1};c(e=>[...e,r]);let o=1,i=setInterval(()=>{o=Math.min(100,o+Math.round(20*Math.random())),c(e=>e.map(e=>e.id===a?{...e,uploadProgress:o}:e)),o>=100&&(clearInterval(i),F(s,"image"),c(e=>e.filter(e=>e.id!==a)))},300);setTimeout(()=>{.05>Math.random()&&(clearInterval(i),c(e=>e.map(e=>e.id===a?{...e,status:"failed",uploadProgress:void 0}:e)))},2500)},t.readAsDataURL(e)}}),(0,a.jsx)(o.N,{children:w&&(0,a.jsx)(i.P.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:20},transition:{duration:.2},className:"absolute bottom-full left-0 right-0 mb-2",children:(0,a.jsx)(V,{onSelect:e=>N(t=>t+e)})})})]})]}),p&&(0,a.jsx)(er,{open:C,onClose:()=>S(!1),conversation:p,currentUserId:m.id,onTogglePin:(e,t)=>x(s=>s.map(s=>s.id===e?{...s,pinned:t}:s)),onToggleMute:(e,t)=>x(s=>s.map(s=>s.id===e?{...s,muted:t}:s))}),(0,a.jsx)(o.N,{children:f&&(0,a.jsx)(q,{imageUrl:f,onClose:()=>k(null)})})]})}}}]);